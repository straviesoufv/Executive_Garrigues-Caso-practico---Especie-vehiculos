<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comparador de neto disponible: compra vs renting (flex)</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#94a3b8;--line:#1f2937;--ok:#16a34a;--bad:#dc2626;--neu:#cbd5e1}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .wrap{max-width:980px;margin:auto;padding:22px 14px}
    h1{font-size:26px;margin:0 0 12px}
    h2{font-size:18px;margin:0 0 8px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
    .span-12{grid-column:span 12}
    .span-6{grid-column:span 6}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
    input{width:100%;box-sizing:border-box;background:#0b1220;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:15px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    td{padding:8px;border-bottom:1px solid var(--line);text-align:right;font-variant-numeric:tabular-nums}
    td:first-child{text-align:left;color:#cbd5e1}
    .kpi{font-size:26px;font-weight:800;margin:8px 0}
    .pill{display:inline-block;border:1px solid #334155;border-radius:999px;padding:2px 8px;font-size:12px;color:#cbd5e1}
    .good{color:var(--ok)} .bad{color:var(--bad)} .neu{color:var(--neu)}
    .result{font-size:30px;font-weight:900;margin:6px 0}

    /* Tooltips legibles */
    .hint{display:inline-flex;align-items:center;gap:6px}
    .hi{display:inline-block;width:18px;height:18px;line-height:18px;text-align:center;border:1px solid #334155;border-radius:50%;font-size:11px;color:#cbd5e1;cursor:help;position:relative}
    .hi:hover::after{content:attr(data-tip);position:absolute;left:50%;transform:translateX(-50%);bottom:135%;max-width:520px;min-width:280px;line-height:1.45;background:#0b1220;color:#e5e7eb;border:1px solid #1f2937;padding:10px 12px;border-radius:10px;white-space:normal;z-index:5;box-shadow:0 10px 28px rgba(0,0,0,.45)}
    .hi:hover::before{content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:124%;border:7px solid transparent;border-top-color:#1f2937}

    @media (max-width:900px){.span-6{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Comparador de neto disponible</h1>


    <div class="grid">
      <!-- 1. Salario e IRPF -->
      <div class="card span-12">
        <h2>Salario e impuestos</h2>
        <div class="grid">
          <div class="span-6">
            <label>Retribución fija bruta anual (€)</label>
            <input id="B" type="number" value="40000" />
          </div>
          <div class="span-6">
            <label>Tipo marginal IRPF (%)</label>
            <input id="t" type="number" step="0.1" value="25" />
          </div>
        </div>
      </div>

      <!-- 2. Compra por su cuenta -->
      <div class="card span-6">
        <h2>Compra por su cuenta</h2>
        <label>Coste mensual estimado del coche (€)</label>
        <input id="costeCompraMensual" type="number" value="590" />
        <p class="kpi" id="kpiCompra">—</p>
        <table><tbody id="tablaCompra"></tbody></table>
      </div>

      <!-- 3. Renting vía flex -->
      <div class="card span-6">
        <h2>Renting vía retribución flexible</h2>
        <label>Cuota renting mensual (€)</label>
        <input id="Cmensual" type="number" value="620" />
        <label>% de uso privativo</label>
        <input id="p" type="number" value="40" />
        <label>Valor de mercado del vehículo (€)</label>
        <input id="V" type="number" value="30000" />
        <div class="grid" style="margin-top:6px">
          <div class="span-6">
            <label>Tipo IRPF (flex) (%) <span class="hi" data-tip="Puedes usar un tipo más bajo si el sacrificio reduce tu marginal efectivo. Por defecto replica el tipo marginal general.">i</span></label>
            <input id="tFlex" type="number" step="0.1" value="25" />
          </div>
          <div class="span-6" style="display:flex;align-items:end;gap:8px;padding-bottom:6px">
            <input id="sameAsMarginal" type="checkbox" checked>
            <label for="sameAsMarginal" style="margin:0;color:#cbd5e1">Igual que el tipo marginal</label>
          </div>
        </div>
        <p class="kpi" id="kpiRenting">—</p>
        <table><tbody id="tablaRenting"></tbody></table>
      </div>

      <!-- 4. Resultado -->
      <div class="card span-12">
        <h2>Resultado</h2>
        <div class="grid">
          <div class="span-4">
            <label>Neto compra</label>
            <p class="kpi" id="netCompra">—</p>
          </div>
          <div class="span-4">
            <label>Neto renting</label>
            <p class="kpi" id="netRenting">—</p>
          </div>
          <div class="span-4">
            <label>Diferencia (renting − compra)</label>
            <p class="result" id="difAbs">—</p>
            <span id="difPct" class="pill">—</span>
          </div>
        </div>
      </div>

      <!-- 5. Tests automáticos (colapsable) -->
      <div class="card span-12">
        <details>
          <summary>Tests automáticos</summary>
          <div id="testsOut" style="margin-top:8px;font-size:14px;color:#cbd5e1"></div>
        </details>
      </div>

    </div>
  </div>

<script>
// Formateo
const fmtEur = v => new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(v);

function getNum(id){
  const v = Number(document.getElementById(id).value);
  return isFinite(v)?v:0;
}

function paintResult(elAbs, elPct, dif){
  elAbs.classList.remove('good','bad','neu');
  elPct.classList.remove('good','bad','neu');
  if(dif>0){ elAbs.classList.add('good'); elPct.classList.add('good'); }
  else if(dif<0){ elAbs.classList.add('bad'); elPct.classList.add('bad'); }
  else { elAbs.classList.add('neu'); elPct.classList.add('neu'); }
}

function calc(){
  const B = getNum('B');
  const t = getNum('t')/100; // tipo marginal general (compra)
  const costeCompraMensual = getNum('costeCompraMensual');
  const Cmens = getNum('Cmensual');
  const p = getNum('p')/100;
  const V = getNum('V');
  const tFlex = getNum('tFlex')/100; // tipo aplicado en flex

  // Compra
  const netoSinCoche = B*(1-t);
  const costeCompraAnual = costeCompraMensual*12;
  const netoCompra = netoSinCoche - costeCompraAnual;
  document.getElementById('kpiCompra').textContent = fmtEur(netoCompra);
  document.getElementById('tablaCompra').innerHTML = `
    <tr><td>Bruto anual</td><td>${fmtEur(B)}</td></tr>
    <tr><td>IRPF (marginal)</td><td>− ${fmtEur(B*t)}</td></tr>
    <tr><td>Neto sin coche</td><td>${fmtEur(netoSinCoche)}</td></tr>
    <tr><td>Coste anual coche</td><td>− ${fmtEur(costeCompraAnual)}</td></tr>
    <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoCompra)}</strong></td></tr>
  `;

  // Renting (flex)
  const Canual = Cmens*12;                   // sacrificio salarial anual
  const especie = 0.20 * V * p;              // valoración fiscal anual
  const brutoReducido = B - Canual;          // dinerario tras flex
  const baseIRPF = brutoReducido + especie;  // base fiscal
  const irpf = baseIRPF * tFlex;             // retención
  const netoRenting = brutoReducido - irpf;  // dinero en mano

  document.getElementById('kpiRenting').textContent = fmtEur(netoRenting);
  document.getElementById('tablaRenting').innerHTML = `
    <tr><td>Bruto anual</td><td>${fmtEur(B)}</td></tr>
    <tr><td class="hint">Cuota renting anual <span class="hi" data-tip="Cuota mensual × 12. Es el sacrificio salarial que reduce el bruto dinerario antes de IRPF.">i</span></td><td>− ${fmtEur(Canual)}</td></tr>
    <tr><td class="hint">Bruto reducido <span class="hi" data-tip="Bruto dinerario tras flex: B − cuota anual. Para Hacienda, 'cobras menos' en metálico.">i</span></td><td>${fmtEur(brutoReducido)}</td></tr>
    <tr><td class="hint">Especie <span class="hi" data-tip="Valoración fiscal anual: 20% × valor de mercado del vehículo × % de uso privativo. No se cobra en metálico, pero tributa.">i</span></td><td>${fmtEur(especie)}</td></tr>
    <tr><td class="hint">Base IRPF <span class="hi" data-tip="La base sobre la que se aplica el IRPF: bruto reducido + especie. La especie se suma como si fuera salario.">i</span></td><td>${fmtEur(baseIRPF)}</td></tr>
    <tr><td class="hint">IRPF (flex) <span class="hi" data-tip="Tipo aplicado en el escenario de flex. Puedes reducirlo si el sacrificio salarial te baja el marginal efectivo.">i</span></td><td>− ${fmtEur(irpf)}</td></tr>
    <tr><td class="hint"><strong>Neto disponible</strong> <span class="hi" data-tip="Bruto reducido − IRPF. No se suma la especie porque no es dinero que recibas.">i</span></td><td><strong>${fmtEur(netoRenting)}</strong></td></tr>
  `;

  // Resultado final y colores
  document.getElementById('netCompra').textContent = fmtEur(netoCompra);
  document.getElementById('netRenting').textContent = fmtEur(netoRenting);
  const dif = netoRenting - netoCompra;
  const elAbs = document.getElementById('difAbs');
  const elPct = document.getElementById('difPct');
  elAbs.textContent = (dif>=0?'+':'') + fmtEur(dif);
  const pct = netoCompra ? (dif/netoCompra*100) : 0;
  elPct.textContent = (pct>=0?'+':'') + pct.toFixed(2) + '%';
  paintResult(elAbs, elPct, dif);
}

// Listeners para recálculo en tiempo real
['B','t','costeCompraMensual','Cmensual','p','V','tFlex','sameAsMarginal'].forEach(id=>{
  document.getElementById(id).addEventListener('input', calc);
});

// Sincroniza tFlex con t cuando el checkbox está activo
const same = document.getElementById('sameAsMarginal');
const tInput = document.getElementById('t');
const tFlexInput = document.getElementById('tFlex');

function syncTFlex(){
  if(same.checked){
    tFlexInput.value = tInput.value;
    tFlexInput.setAttribute('disabled','disabled');
  } else {
    tFlexInput.removeAttribute('disabled');
  }
}

same.addEventListener('change', ()=>{ syncTFlex(); calc(); });
tInput.addEventListener('input', ()=>{ if(same.checked){ syncTFlex(); calc(); } });

// --- Tests automáticos ---
function almostEqual(a,b,eps=0.6){ return Math.abs(a-b) <= eps; }
function runTests(){
  const out = [];

  // Caso base: B=40k, t=25%, coste compra=590, C=620, p=40%, V=30000
  const B=40000, t=0.25, Cmens=620, p=0.40, V=30000, coste=590, tFlex=0.25;
  const netCompra = B*(1-t) - coste*12; // 30000 - 7080 = 22920
  const Canual = Cmens*12; // 7440
  const especie = 0.20*V*p; // 2400
  const netFlex = (B-Canual) - tFlex*((B-Canual)+especie); // 23820
  out.push(`Test 1 (base): compra=${fmtEur(netCompra)}, flex=${fmtEur(netFlex)} → ${(almostEqual(netCompra,22920)&&almostEqual(netFlex,23820))?'OK':'FALLO'}`);

  // p=81% con mismo V
  const p2 = 0.81; const especie2 = 0.20*V*p2; // 4860
  const netFlex2 = (B-Canual) - tFlex*((B-Canual)+especie2); // 23205
  out.push(`Test 2 (priv. 81%): flex=${fmtEur(netFlex2)} → ${almostEqual(netFlex2,23205)?'OK':'FALLO'}`);

  // V=35400, p=40%
  const V3=35400; const especie3=0.20*V3*p; // 2832
  const netFlex3=(B-Canual)-tFlex*((B-Canual)+especie3); // 23712
  out.push(`Test 3 (V=35.4k, p=40%): flex=${fmtEur(netFlex3)} → ${almostEqual(netFlex3,23712)?'OK':'FALLO'}`);

  document.getElementById('testsOut').innerHTML = out.map(x=>`<div>${x}</div>`).join('');
}

// Init
syncTFlex();
calc();
runTests();
</script>
</body>
</html>
