<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comparador de neto disponible: compra vs renting (flex)</title>

  <style>
    /* ================== Identidad y sistema de diseño ================== */
    :root{
      /* Paleta */
      --ufv-blue-900:#0a2a4a; --ufv-blue-800:#0c3563; --ufv-blue-700:#114a7a; --ufv-blue-600:#165e95;
      --ufv-blue-100:#e9f1fb; --ufv-ink:#0f1720; --ufv-ink-muted:#4b5563; --panel:#ffffff; --bg:#f6f8fc;
      --line:#e5e7eb; --ok:#0f8a41; --bad:#c21f2f; --neu:#6b7280; --shadow:0 6px 18px rgba(10,42,74,.08);
      --radius:14px;

      /* Espacios y densidad */
      --space-1:6px; --space-2:10px; --space-3:14px; --space-4:18px; --space-5:24px; --space-6:32px;
      --grid-gap: var(--space-3);
      --block-gap: var(--space-5);
      --control-gap: var(--space-3);
      --table-padding-y: 10px;
      --table-padding-x: 10px;
      --para-lh: 1.45;
    }
    body.compact {
      --grid-gap: 10px;
      --block-gap: var(--space-4);
      --control-gap: var(--space-2);
      --table-padding-y: 8px;
      --table-padding-x: 8px;
    }

    html,body{
      margin:0; background:var(--bg); color:var(--ufv-ink);
      font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .t-title{ font-family:"Times New Roman", Times, serif; letter-spacing:.2px }
    .t-numeral{ font-family:Rockwell,"Segoe UI","Arial Black",Arial,sans-serif; letter-spacing:.2px }

    .wrap{max-width:1280px;margin:auto;padding:22px 16px}

    /* ================== Header ================== */
    .site-header{
      background:linear-gradient(0deg, var(--ufv-blue-800), var(--ufv-blue-900));
      color:#fff; box-shadow: var(--shadow);
    }
    .site-header .inner{
      max-width:1280px;margin:0 auto;padding:14px 16px;
      display:flex;align-items:center;gap:16px; justify-content:space-between;
    }
    .brand{display:flex;align-items:center;gap:14px;text-decoration:none;color:inherit}
    .brand img{height:44px;width:auto;display:block}
    .brand-title{display:flex;flex-direction:column}
    .brand-title h1{margin:0;font-size:22px;font-weight:800}
    .brand-title span{opacity:.9;font-size:13px}

    /* Controles de vista */
    .view-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .vc-chip{
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(255,255,255,.1); color:#fff; border:1px solid rgba(255,255,255,.25);
      padding:6px 10px; border-radius:999px; font-size:13px; cursor:pointer; user-select:none;
    }
    .vc-chip input{accent-color:#fff}

    /* ================== Hero ================== */
    .hero{background:#fff;border-bottom:1px solid var(--line)}
    .hero .inner{max-width:1280px;margin:0 auto;padding:18px 16px 10px}
    .hero h2{margin:0;font-size:26px;color:var(--ufv-blue-900)}
    .hero p{margin:6px 0 0;color:#1f2937; line-height: var(--para-lh); max-width: 72ch}

    /* ================== Grid y tarjetas ================== */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--grid-gap)}
    .card{
      background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);
      padding:var(--space-4);box-shadow:var(--shadow)
    }
    .span-12{grid-column:span 12}
    .span-6{grid-column:span 6}
    .span-4{grid-column:span 4}
    .span-6.tight{padding:var(--space-3) var(--space-4);} /* tarjeta compacta */

    h3{margin:0 0 var(--space-3);font-size:18px;color:var(--ufv-blue-900)}

    /* Controles */
    label{display:block;font-size:13px;color:var(--ufv-ink-muted);margin:var(--control-gap) 0 6px}
    input,select{
      width:100%;box-sizing:border-box;background:#fff;color:var(--ufv-ink);
      border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:15px;
      outline:none;transition:border .15s, box-shadow .15s
    }
    input:focus, select:focus{
      border-color:var(--ufv-blue-600);
      box-shadow:0 0 0 3px color-mix(in srgb, var(--ufv-blue-600) 20%, transparent);
    }
    .helper{color:var(--ufv-ink-muted);font-size:12px;margin-top:4px}

    /* Tablas */
    table{width:100%;border-collapse:collapse;margin-top:var(--space-2)}
    td{
      padding:var(--table-padding-y) var(--table-padding-x);
      border-bottom:1px solid var(--line);
      text-align:right;font-variant-numeric:tabular-nums
    }
    tr:nth-child(even) td{ background: #fafbfc; }
    td:first-child{text-align:left;color:#334155}
    .table-compact td{padding:6px 8px}

    /* KPIs y pill */
    .kpi{font-size:28px;font-weight:800;margin:var(--space-2) 0}
    .pill{display:inline-block;border:1px solid #cbd5e1;border-radius:999px;padding:2px 8px;font-size:12px;color:#334155;background:var(--ufv-blue-100)}
    .good{color:var(--ok)} .bad{color:var(--bad)} .neu{color:var(--neu)}
    .result{font-size:30px;font-weight:900;margin:6px 0}
    .muted{color:var(--ufv-ink-muted)}

    /* Tooltips */
    .hint{display:inline-flex;align-items:center;gap:6px}
    .hi{
      display:inline-block;width:18px;height:18px;line-height:18px;text-align:center;
      border:1px solid #cbd5e1;border-radius:50%;font-size:11px;color:#1f2937;cursor:help;position:relative;background:#fff
    }
    .hi:hover::after{
      content:attr(data-tip); position:absolute; left:50%; transform:translateX(-50%);
      bottom:135%; max-width:520px; min-width:280px; line-height:var(--para-lh);
      background:#fff; color:#0f1720; border:1px solid var(--line);
      padding:10px 12px; border-radius:10px; white-space:normal; z-index:5; box-shadow:var(--shadow)
    }
    .hi:hover::before{content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:124%;border:7px solid transparent;border-top-color:var(--line)}
    tr:hover td { background: #f6f8fb; }

    /* Acordeones */
    details{margin-top:var(--space-3); border-top:1px solid var(--line); padding-top:var(--space-2)}
    summary{
      list-style:none; cursor:pointer; font-weight:700; color:var(--ufv-blue-900);
      display:flex; align-items:center; gap:8px;
    }
    summary::-webkit-details-marker { display:none; }
    summary::before{
      content:"▸"; transition: transform .2s; font-size:14px; color:var(--ufv-blue-900);
    }
    details[open] summary::before{ transform: rotate(90deg); }
    .overline{ color: var(--ufv-ink-muted); font-size:12px; letter-spacing:.08em; text-transform:uppercase; margin-top: var(--space-3) }

    /* Layout lateral */
    .layout{display:grid;grid-template-columns: 1fr 420px;gap:var(--grid-gap);align-items:start; margin-top: var(--block-gap)}
    .aside-sticky{position:sticky;top:16px}
    @media (max-width:1024px){
      .layout{grid-template-columns: 1fr}
      .aside-sticky{position:static}
    }

    /* Acordeón de tarjeta completa */
    .card > details{ border-top:none; padding-top:0; margin-top:0 }
    .card summary{
      margin:-6px -6px var(--space-2);
      padding:8px 6px;
      border-radius:10px;
    }
    .card summary:hover{ background:#f8fafc }

    /* Fila de resumen enfatizada */
    .emph-row td{ font-weight:800; font-size:16px; background:#f1f5f9; }
    .emph-row td:first-child{ letter-spacing:.2px; }

    /* Footer */
    .site-footer{color:var(--ufv-ink-muted);font-size:12px;padding:18px 0 28px;text-align:center}
  </style>
</head>
<body>
  <!-- Cabecera institucional -->
  <header class="site-header">
    <div class="inner">
      <a class="brand" href="#">
        <img id="ufvLogo" src="./logo-UFV-blanco.png" alt="UFV"
             onerror="this.onerror=null; this.src='./logo-UFV.png';">
        <div class="brand-title">
          <h1 class="t-title">CASO PRÁCTICO</h1>
          <span>Comparador de neto disponible · compra vs renting (flex)</span>
        </div>
      </a>

      <!-- Controles de vista -->
      <div class="view-controls" aria-label="Preferencias de visualización">
<!--         <label class="vc-chip" title="Aumenta o reduce espacios y padding">
          <input id="toggleDensity" type="checkbox"> Densidad compacta
        </label> -->
        <label class="vc-chip" title="Aplicar tramos de IRPF en lugar de tipo fijo">
          <input id="toggleTramos" type="checkbox"> Calcular con tramos
        </label>
        <button id="expandAll" class="vc-chip" type="button" title="Mostrar todos los escenarios">Expandir todo</button>
        <button id="collapseAll" class="vc-chip" type="button" title="Ocultar todos los escenarios">Contraer todo</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="inner">
      <h2 class="t-title">Caso práctico de compensación - Máster Executive Garrigues 2025</h2>
      <p>Simula el neto disponible al comprar un vehículo por tu cuenta, por renting vía retribución flexible o por entrega en propiedad (retribución en especie).</p>
    </div>
  </section>

  <!-- Contenido -->
  <div class="wrap">
    <div class="layout">

      <!-- MAIN -->
      <main class="grid">
        <!-- 1. Salario e IRPF -->
        <div class="card span-12">
          <h3 class="t-title">Salario e impuestos</h3>
          <div class="grid">
            <div class="span-6">
              <label for="B">Retribución fija bruta anual (€)</label>
              <input id="B" type="text" value="40000 €" data-type="eur" />
            </div>
            <div class="span-6">
              <label for="t">Tipo marginal IRPF (%) <span class="hi" data-tip="Solo se usa si 'Calcular con tramos' está desactivado.">i</span></label>
              <input id="t" type="text" value="25 %" data-type="pct" />
            </div>
          </div>
        </div>

        <!-- 2. Compra por su cuenta -->
        <div class="card span-6">
          <details>
            <summary><h3 class="t-title" style="margin:0">Compra por su cuenta</h3></summary>

            <label for="costeCompraMensual">Coste mensual estimado del coche (€)</label>
            <input id="costeCompraMensual" type="text" value="590 €" data-type="eur" />

            <p class="overline">KPI</p>
            <p class="kpi t-numeral" id="kpiCompra">&mdash;</p>

            <details>
              <summary>Resumen</summary>
              <table><tbody id="tablaCompraResumen"></tbody></table>
            </details>
            <details>
              <summary>Detalle del cálculo</summary>
              <table><tbody id="tablaCompraDetalle"></tbody></table>
            </details>
          </details>
        </div>

        <!-- 2b. Entrega del vehículo en propiedad (debajo de compra) -->
        <div class="card span-6 tight">
          <details>
            <summary><h3 class="t-title" style="margin:0">Entrega del vehículo en propiedad</h3></summary>

            <label for="tipoEntrega">Tipo de entrega</label>
            <select id="tipoEntrega">
              <option value="directa">Entrega directa (sin uso previo)</option>
              <option value="posterior">Uso previo y posterior entrega</option>
            </select>

            <label for="costeAdq">Coste de adquisición para el empleador (€)
              <span class="hi" data-tip="Incluye IVA, IEDMT y gastos.">i</span>
            </label>
            <input id="costeAdq" type="text" value="30000 €" data-type="eur" />

            <div id="bloquePosterior" style="display:none">
              <label for="aniosUso">Años de uso antes de la entrega</label>
              <input id="aniosUso" type="text" value="3" data-type="num" />
              <label for="vmEntrega">Valor de mercado en la fecha de entrega (€)</label>
              <input id="vmEntrega" type="text" value="20000 €" data-type="eur" />
            </div>

            <div class="grid" style="margin-top:var(--control-gap)">
              <div class="span-6">
                <label for="tEnt">Tipo IRPF (entrega) (%) <span class="hi" data-tip="Solo se usa si 'Calcular con tramos' está desactivado.">i</span></label>
                <input id="tEnt" type="text" value="25 %" data-type="pct" />
              </div>
              <div class="span-6" style="display:flex;align-items:end;gap:8px;padding-bottom:6px">
                <input id="sameAsMarginalEnt" type="checkbox" checked aria-describedby="sameEntLbl">
                <label id="sameEntLbl" for="sameAsMarginalEnt" style="margin:0;">Igual que el tipo marginal general</label>
              </div>
            </div>

            <label for="ingresoEntregaSel">Ingreso a cuenta de la entrega</label>
            <select id="ingresoEntregaSel">
              <option value="repercutido">Repercutido al trabajador</option>
              <option value="norepercutido">No repercutido (lo asume la empresa)</option>
            </select>

            <p class="overline">KPI</p>
            <p class="kpi t-numeral" id="kpiEntrega">&mdash;</p>

            <details>
              <summary>Resumen de la entrega</summary>
              <table><tbody id="tablaEntregaResumen"></tbody></table>
            </details>
            <details>
              <summary>Detalle de retenciones (entrega)</summary>
              <table><tbody id="tablaEntregaDetalle"></tbody></table>
            </details>
          </details>
        </div>

        <!-- 3. Renting vía flex -->
        <div class="card span-6">
          <details>
            <summary><h3 class="t-title" style="margin:0">Renting vía retribución flexible</h3></summary>

            <label for="Cmensual">Cuota renting mensual (€)</label>
            <input id="Cmensual" type="text" value="620 €" data-type="eur" />

            <label for="p">% de uso privativo</label>
            <input id="p" type="text" value="40 %" data-type="pct" />

            <label for="V">Valor de mercado del vehículo para AEAT (€)
              <span class="hi" data-tip="La AEAT toma el 20% anual de este valor.">i</span>
            </label>
            <input id="V" type="text" value="30000 €" data-type="eur" />

            <label for="ecoRed">Reducción eficiencia (art. 48 bis RIRPF)</label>
            <select id="ecoRed" aria-label="Reducción por eficiencia energética">
              <option value="0">Sin reducción (0%)</option>
              <option value="0.15">15% · Euro 6, ≤120 g CO₂ y ≤25.000 € sin impuestos</option>
              <option value="0.20">20% · Euro 6 + híbrido/GLP/GN, ≤35.000 € sin impuestos</option>
              <option value="0.30">30% · BEV/E-REV/PHEV (≥15 km), ≤40.000 € sin impuestos</option>
            </select>

            <div class="grid" style="margin-top:var(--control-gap)">
              <div class="span-6">
                <label for="tFlex">Tipo IRPF (flex) (%) <span class="hi" data-tip="Solo se usa si 'Calcular con tramos' está desactivado.">i</span></label>
                <input id="tFlex" type="text" value="25 %" data-type="pct" />
              </div>
              <div class="span-6" style="display:flex;align-items:end;gap:8px;padding-bottom:6px">
                <input id="sameAsMarginal" type="checkbox" checked aria-describedby="samelabel">
                <label id="samelabel" for="sameAsMarginal" style="margin:0;">Igual que el tipo marginal general</label>
              </div>
            </div>

            <label for="ingresoCuentaSel">Ingreso a cuenta de la especie</label>
            <select id="ingresoCuentaSel" aria-label="Ingreso a cuenta">
              <option value="repercutido">Repercutido al trabajador</option>
              <option value="norepercutido">No repercutido (lo asume la empresa)</option>
            </select>

            <p class="overline">KPI</p>
            <p class="kpi t-numeral" id="kpiRenting">&mdash;</p>

            <details>
              <summary>Resumen fiscal</summary>
              <table><tbody id="tablaRentingResumen"></tbody></table>
            </details>
            <details>
              <summary>Detalle de retenciones</summary>
              <table><tbody id="tablaRentingDetalle"></tbody></table>
            </details>
          </details>
        </div>
      </main>

      <!-- ASIDE: resultado comparativo + NotebookLM + AEAT -->
      <aside class="aside-sticky">
        <div class="card">
          <h3 class="t-title">Resultado</h3>

          <table class="table-compact" style="margin-top:4px">
            <tbody id="tablaResumen">
              <tr><td>Compra por su cuenta</td><td style="text-align:right" id="rCompra">—</td></tr>

              <!-- Entrega directa -->
              <tr><td>Entrega directa (ingreso repercutido)</td><td style="text-align:right" id="rEntDirRep">—</td></tr>
              <tr><td>Entrega directa (ingreso no repercutido)</td><td style="text-align:right" id="rEntDirNoRep">—</td></tr>

              <!-- Entrega posterior -->
              <tr><td>Entrega posterior (ingreso repercutido)</td><td style="text-align:right" id="rEntPosRep">—</td></tr>
              <tr><td>Entrega posterior (ingreso no repercutido)</td><td style="text-align:right" id="rEntPosNoRep">—</td></tr>

              <!-- Renting -->
              <tr><td>Renting flex (ingreso repercutido)</td><td style="text-align:right" id="rFlexRep">—</td></tr>
              <tr><td>Renting flex (ingreso no repercutido)</td><td style="text-align:right" id="rFlexNoRep">—</td></tr>

              <!-- Deltas vs compra -->
              <tr class="emph-row">
                <td>Diferencia vs compra · Entrega directa (repercutido)</td>
                <td style="text-align:right" id="dEntDirRep">—</td>
              </tr>
              <tr class="emph-row">
                <td>Diferencia vs compra · Entrega directa (no repercutido)</td>
                <td style="text-align:right" id="dEntDirNoRep">—</td>
              </tr>
              <tr class="emph-row">
                <td>Diferencia vs compra · Entrega posterior (repercutido)</td>
                <td style="text-align:right" id="dEntPosRep">—</td>
              </tr>
              <tr class="emph-row">
                <td>Diferencia vs compra · Entrega posterior (no repercutido)</td>
                <td style="text-align:right" id="dEntPosNoRep">—</td>
              </tr>
              <tr class="emph-row">
                <td>Diferencia vs compra · Renting (repercutido)</td>
                <td style="text-align:right" id="dRep">—</td>
              </tr>
              <tr class="emph-row">
                <td>Diferencia vs compra · Renting (no repercutido)</td>
                <td style="text-align:right" id="dNoRep">—</td>
              </tr>
            </tbody>
          </table>

          <!-- Enlace NotebookLM visible -->
          <div style="margin:16px 0; text-align:center">
            <a href="https://notebooklm.google.com/notebook/64643cca-c6ac-43ac-9c79-a8525b5cb14b"
               target="_blank" rel="noopener noreferrer" aria-label="Abrir NotebookLM con documentación del caso"
               style="display:inline-block; background:var(--ufv-blue-700); color:#fff;
                      padding:10px 16px; border-radius:8px; font-weight:700; text-decoration:none;
                      box-shadow:var(--shadow); transition:background .2s">
              💬 Pregunta sobre la ley
            </a>
          </div>

          <details style="margin-top:14px">
            <summary>Referencia AEAT y resumen</summary>
            <div style="margin-top:10px; font-size:13px; color:#334155">
              <p style="margin:6px 0 10px">
                <a href="https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c03-rendimientos-trabajo/rendimientos-trabajo-especie/computo-rendimientos-trabajo-especie/reglas-especiales/entrega-utilizacion-vehiculos-automoviles.html"
                  target="_blank" rel="noopener noreferrer">
                  Página oficial · AEAT · Entrega o utilización de vehículos automóviles
                </a>
              </p>
              <ul style="margin:0 0 10px 18px; padding:0; line-height:1.45">
                <li><strong>Entrega</strong>: coste de adquisición para el empleador + impuestos y gastos, o si hubo uso previo: VM en fecha − 20% anual ya imputado.</li>
                <li><strong>Utilización</strong>: propiedad empresa → 20% anual × coste; no propiedad → 20% anual × VM nuevo.</li>
                <li><em>Incluye</em> seguros/IVTM/mantenimiento; <em>no</em> incluye combustible.</li>
                <li>Uso mixto: imputar por <strong>disponibilidad para uso particular</strong> (% privado).</li>
                <li><strong>Reducciones eco (art. 48 bis RIRPF)</strong>: −15% / −20% / −30% con límites de precio sin impuestos.</li>
              </ul>
            </div>
          </details>
        </div>
      </aside>

    </div>

    <footer class="site-footer">Sergio Travieso · UFV · 2025</footer>
  </div>

  <script>
    /* ===== Helpers formato/parseo ===== */
    const fmtEur = v => new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:2}).format(v);
    const fmtPct = v => new Intl.NumberFormat('es-ES',{maximumFractionDigits:2}).format(v) + ' %';

    function parseLocaleNumber(input){
      if(typeof input !== 'string') input = String(input ?? '');
      let s = input.trim(); if(!s) return 0;
      const neg = /^-/.test(s) ? -1 : 1;
      s = s.replace(/[^0-9.,]/g,''); if(!s) return 0;
      const lastComma = s.lastIndexOf(','), lastDot = s.lastIndexOf('.'); const decPos = Math.max(lastComma,lastDot);
      if(decPos >= 0){
        const intPart = s.slice(0, decPos).replace(/[.,]/g,'');
        const fracPart = s.slice(decPos+1).replace(/[.,]/g,'');
        return neg * parseFloat((intPart || '0') + '.' + (fracPart || '0'));
      }
      return neg * parseFloat(s.replace(/[.,]/g,''));
    }
    function getNum(id){ return parseLocaleNumber(document.getElementById(id).value); }
    function getSelNum(id){ return Number(document.getElementById(id).value) || 0; }
    function formatInput(el){
      const t = el.dataset.type; const num = getNum(el.id);
      if(t==='eur') el.value = fmtEur(num);
      else if(t==='pct') el.value = fmtPct(num);
      else el.value = new Intl.NumberFormat('es-ES',{maximumFractionDigits:2}).format(num);
    }
    function unformatOnFocus(el){
      const val = getNum(el.id);
      if(el.dataset.type==='pct'){ el.value = String(val).replace('.',','); }
      else { el.value = String(val); }
    }
    function paintDeltaCell(td, value){
      td.classList.remove('good','bad','neu');
      if(value>0) td.classList.add('good'); else if(value<0) td.classList.add('bad'); else td.classList.add('neu');
      td.textContent = (value>=0?'+':'') + fmtEur(value);
    }

    /* ===== Impuesto por TRAMOS =====
       Tabla orientativa estatal+autonómico medio 2024/25.
       Formato: límites superiores de tramo y tipo del tramo.
       Interpreta [12450, 0.19] como 0..12450 al 19%; el último usa Infinity.
    */
    const TAX_TABLE = [
      [12450, 0.19],
      [20200, 0.24],
      [35200, 0.30],
      [60000, 0.37],
      [300000, 0.45],
      [Infinity, 0.47] // si quieres 0.49 para ciertas CCAA, cámbialo aquí
    ];

    function taxByBrackets(base, table=TAX_TABLE){
      base = Math.max(0, base || 0);
      let prev = 0, tax = 0;
      for(const [limit, rate] of table){
        const span = Math.min(base, limit) - prev;
        if(span > 0){ tax += span * rate; prev += span; }
        if(base <= limit) break;
      }
      return tax;
    }
    function marginalRate(base, table=TAX_TABLE){
      base = Math.max(0, base || 0);
      let prev = 0;
      for(const [limit, rate] of table){
        if(base <= limit) return rate;
        prev = limit;
      }
      return table[table.length-1][1];
    }

    // Resuelve G en casos "no repercutido": Tax(base0 + extra + G) − Tax(base0) − G = 0
    function solveG_bisection(base0, extra, table=TAX_TABLE){
      const f = (G) => taxByBrackets(base0 + extra + G, table) - taxByBrackets(base0, table) - G;

      let lo = 0, hi;
      const rmax = table[table.length-1][1];
      hi = (extra > 0) ? extra * rmax / Math.max(1e-9, (1 - rmax)) : 0;
      if(!isFinite(hi) || hi <= 0) hi = Math.max(1000, Math.abs(extra) * 10);

      // Asegurar f(lo) <= 0 y f(hi) >= 0
      let flo = f(lo), fhi = f(hi);
      let guard = 0;
      while(fhi < 0 && guard < 30){ hi *= 2; fhi = f(hi); guard++; }
      // Si aún negativo, retorna 0 por seguridad
      if(fhi < 0) return 0;

      // Bisección
      for(let i=0;i<60;i++){
        const mid = 0.5*(lo+hi);
        const fm = f(mid);
        if(Math.abs(fm) < 1e-6) return mid;
        if(fm < 0){ lo = mid; flo = fm; } else { hi = mid; fhi = fm; }
      }
      return 0.5*(lo+hi);
    }

    // Mostrar/ocultar inputs de tipo fijo cuando tramos ON
    function setFlatInputsDisabled(disabled){
      ['t','tFlex','tEnt'].forEach(id=>{
        const el = document.getElementById(id);
        if(el){ el.disabled = disabled; el.style.opacity = disabled ? .6 : 1; }
      });
    }

    // Expandir/Contraer todos los escenarios (solo los details de primer nivel en .card)
    document.getElementById('expandAll').addEventListener('click', ()=>{
      document.querySelectorAll('.card > details').forEach(d=>d.open=true);
    });
    document.getElementById('collapseAll').addEventListener('click', ()=>{
      document.querySelectorAll('.card > details').forEach(d=>d.open=false);
    });

    /* ===== Cálculo principal ===== */
    function calc(){
      const B = getNum('B');
      const useBrackets = document.getElementById('toggleTramos').checked;

      // Tipos fijos solo si NO usamos tramos
      const t     = useBrackets ? null : getNum('t')/100;

      /* ===== COMPRA ===== */
      const costeCompraMensual = getNum('costeCompraMensual');
      const costeCompraAnual = costeCompraMensual*12;

      const taxCompra = useBrackets ? taxByBrackets(B) : (B * (t ?? 0));
      const netoSinCoche = B - taxCompra;
      const netoCompra = netoSinCoche - costeCompraAnual;

      // KPI + Resumen + Detalle
      document.getElementById('kpiCompra').textContent = fmtEur(netoCompra);
      document.getElementById('tablaCompraResumen').innerHTML = `
        <tr><td>Neto sin coche</td><td>${fmtEur(netoSinCoche)}</td></tr>
        <tr><td>Coste anual coche</td><td>− ${fmtEur(costeCompraAnual)}</td></tr>
        <tr class="emph-row"><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoCompra)}</strong></td></tr>
      `;
      document.getElementById('tablaCompraDetalle').innerHTML = `
        <tr><td>Bruto anual</td><td>${fmtEur(B)}</td></tr>
        <tr><td>${useBrackets?'Cuota por tramos':'IRPF (marginal fijo)'}</td><td>− ${fmtEur(taxCompra)}</td></tr>
        <tr><td>Neto sin coche</td><td>${fmtEur(netoSinCoche)}</td></tr>
        <tr><td>Coste anual coche</td><td>− ${fmtEur(costeCompraAnual)}</td></tr>
        <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoCompra)}</strong></td></tr>
      `;

      /* ===== ENTREGA EN PROPIEDAD ===== */
      const tipoEntrega = document.getElementById('tipoEntrega').value; // directa | posterior
      const costeAdq = getNum('costeAdq');
      const aniosUso = getNum('aniosUso');
      const vmEntrega = getNum('vmEntrega');
      const tEnt  = useBrackets ? null : getNum('tEnt')/100;
      const ingresoEntregaSel = document.getElementById('ingresoEntregaSel').value; // repercutido | norepercutido

      // Valoraciones para ambos escenarios (SIEMPRE)
      const valorEntregaDir = costeAdq;
      const valoracionUsoAcum = 0.20 * costeAdq * (isFinite(aniosUso) ? aniosUso : 0);
      const valorEntregaPos = Math.max(0, vmEntrega - valoracionUsoAcum);

      function netoEntrega(valor, repercutido){
        if(useBrackets){
          if(repercutido){
            const base = B + valor;
            const tax = taxByBrackets(base);
            return B - tax;
          }else{
            const G = solveG_bisection(B, valor);
            const taxDiff = taxByBrackets(B + valor + G) - taxByBrackets(B);
            const retNom = taxDiff - G;
            return B - retNom;
          }
        } else {
          if(repercutido){
            const base = B + valor, irpf = base * (tEnt ?? 0);
            return B - irpf;
          }else{
            const G = valor * (tEnt ?? 0) / (1 - (tEnt ?? 0));
            const base = B + valor + G;
            const retTot = base * (tEnt ?? 0);
            const irpfNom = retTot - G;
            return B - irpfNom;
          }
        }
      }

      const netEntDirRep   = netoEntrega(valorEntregaDir, true);
      const netEntDirNoRep = netoEntrega(valorEntregaDir, false);
      const netEntPosRep   = netoEntrega(valorEntregaPos, true);
      const netEntPosNoRep = netoEntrega(valorEntregaPos, false);

      // KPI y desgloses de la tarjeta (según selección)
      const valorEntregaSeleccionado = (tipoEntrega === 'directa') ? valorEntregaDir : valorEntregaPos;
      const netoEntregaMostrar = (ingresoEntregaSel === 'norepercutido')
        ? netoEntrega(valorEntregaSeleccionado, false)
        : netoEntrega(valorEntregaSeleccionado, true);

      document.getElementById('kpiEntrega').textContent = fmtEur(netoEntregaMostrar);
      document.getElementById('tablaEntregaResumen').innerHTML = `
        <tr><td>Tipo de entrega</td><td>${tipoEntrega==='directa'?'Directa (sin uso previo)':'Uso previo y posterior entrega'}</td></tr>
        <tr><td>Valoración de entrega</td><td>${fmtEur(valorEntregaSeleccionado)}</td></tr>
        <tr class="emph-row"><td><strong>Neto disponible (según opción elegida)</strong></td><td><strong>${fmtEur(netoEntregaMostrar)}</strong></td></tr>
      `;

      if(ingresoEntregaSel === 'norepercutido'){
        if(useBrackets){
          const G = solveG_bisection(B, valorEntregaSeleccionado);
          const baseB = B, baseA = B + valorEntregaSeleccionado + G;
          const taxDiff = taxByBrackets(baseA) - taxByBrackets(baseB);
          const irpfNom = taxDiff - G;
          document.getElementById('tablaEntregaDetalle').innerHTML = `
            <tr><td class="hint">Ingreso a cuenta (empresa) <span class="hi" data-tip="Resuelto por bisección: Tax(B+V+G)−Tax(B)=G">i</span></td><td>${fmtEur(G)}</td></tr>
            <tr><td>Base antes / después</td><td>${fmtEur(baseB)} → ${fmtEur(baseA)}</td></tr>
            <tr><td>Retención total teórica</td><td>${fmtEur(taxDiff)}</td></tr>
            <tr><td>Retención desde nómina</td><td>− ${fmtEur(irpfNom)}</td></tr>
            <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoEntregaMostrar)}</strong></td></tr>
          `;
        }else{
          const G = valorEntregaSeleccionado * (tEnt ?? 0) / (1 - (tEnt ?? 0));
          const base = B + valorEntregaSeleccionado + G;
          const retTot = base * (tEnt ?? 0);
          const irpfNom = retTot - G;
          document.getElementById('tablaEntregaDetalle').innerHTML = `
            <tr><td class="hint">Ingreso a cuenta (empresa) <span class="hi" data-tip="G = V × t / (1 − t)">i</span></td><td>${fmtEur(G)}</td></tr>
            <tr><td>Base IRPF (teórica)</td><td>${fmtEur(base)}</td></tr>
            <tr><td>Retención total teórica</td><td>${fmtEur(retTot)}</td></tr>
            <tr><td>Retención desde nómina</td><td>− ${fmtEur(irpfNom)}</td></tr>
            <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoEntregaMostrar)}</strong></td></tr>
          `;
        }
      } else {
        if(useBrackets){
          const base = B + valorEntregaSeleccionado;
          const tax = taxByBrackets(base);
          document.getElementById('tablaEntregaDetalle').innerHTML = `
            <tr><td>Base IRPF</td><td>${fmtEur(base)}</td></tr>
            <tr><td>Cuota por tramos</td><td>− ${fmtEur(tax)}</td></tr>
            <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoEntregaMostrar)}</strong></td></tr>
          `;
        }else{
          const base = B + valorEntregaSeleccionado;
          const irpf = base * (tEnt ?? 0);
          document.getElementById('tablaEntregaDetalle').innerHTML = `
            <tr><td>Base IRPF</td><td>${fmtEur(base)}</td></tr>
            <tr><td>IRPF</td><td>− ${fmtEur(irpf)}</td></tr>
            <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoEntregaMostrar)}</strong></td></tr>
          `;
        }
      }

      /* ===== RENTING (uso) ===== */
      const Cmens = getNum('Cmensual');
      const p = getNum('p')/100;
      const V = getNum('V');
      const ecoRed = getSelNum('ecoRed'); // 0, 0.15, 0.20, 0.30
      const tFlex = useBrackets ? null : getNum('tFlex')/100;
      const ingresoCuentaSel = document.getElementById('ingresoCuentaSel').value; // repercutido | norepercutido

      const Canual = Cmens*12;
      const valoracionBase20 = 0.20*V;
      const valoracionAnual = valoracionBase20 * (1 - ecoRed);
      const especie = valoracionAnual * p;
      const brutoReducido = B - Canual;

      let netoFlex_A, netoFlex_B, kpiRenting;

      if(useBrackets){
        // Repercutido
        const baseA = brutoReducido + especie;
        const taxA = taxByBrackets(baseA);
        netoFlex_A = (B - Canual) - taxA;

        // No repercutido: resolver G con bisección respecto a base dineraria (B − C)
        const G = solveG_bisection(B - Canual, especie);
        const taxDiff = taxByBrackets(brutoReducido + especie + G) - taxByBrackets(brutoReducido);
        const irpfNom = taxDiff - G;
        netoFlex_B = (B - Canual) - irpfNom;

        kpiRenting = (ingresoCuentaSel === 'norepercutido') ? netoFlex_B : netoFlex_A;

        document.getElementById('tablaRentingResumen').innerHTML = `
          <tr><td class="hint">Cuota renting anual <span class="hi" data-tip="Sacrificio salarial antes de IRPF">i</span></td><td>− ${fmtEur(Canual)}</td></tr>
          <tr><td>Valoración anual (20% × V)</td><td>${fmtEur(valoracionBase20)}</td></tr>
          <tr><td>Reducción eficiencia aplicada</td><td>${new Intl.NumberFormat('es-ES',{maximumFractionDigits:2}).format(ecoRed*100)} %</td></tr>
          <tr><td>Base tras reducción</td><td>${fmtEur(valoracionAnual)}</td></tr>
          <tr><td>Especie imputable (% uso)</td><td>${fmtEur(especie)}</td></tr>
          <tr class="emph-row"><td><strong>Neto disponible (según opción elegida)</strong></td><td><strong>${fmtEur(kpiRenting)}</strong></td></tr>
        `;

        if(ingresoCuentaSel === 'norepercutido'){
          document.getElementById('tablaRentingDetalle').innerHTML = `
            <tr><td>Base dineraria (B − C)</td><td>${fmtEur(brutoReducido)}</td></tr>
            <tr><td class="hint">Ingreso a cuenta (empresa) <span class="hi" data-tip="Resuelto por bisección: Tax(B−C+E+G)−Tax(B−C)=G">i</span></td><td>${fmtEur(G)}</td></tr>
            <tr><td>Retención total teórica</td><td>${fmtEur(taxDiff)}</td></tr>
            <tr><td>Retención desde nómina</td><td>− ${fmtEur(irpfNom)}</td></tr>
            <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoFlex_B)}</strong></td></tr>
          `;
        } else {
          document.getElementById('tablaRentingDetalle').innerHTML = `
            <tr><td>Bruto reducido</td><td>${fmtEur(brutoReducido)}</td></tr>
            <tr><td>Base IRPF (B − C + E)</td><td>${fmtEur(baseA)}</td></tr>
            <tr><td>Cuota por tramos</td><td>− ${fmtEur(taxA)}</td></tr>
            <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoFlex_A)}</strong></td></tr>
          `;
        }

      } else {
        // Modelo plano (tFlex)
        const baseA = brutoReducido + especie;
        const irpf_A = baseA * (tFlex ?? 0);
        netoFlex_A = (B - Canual) - irpf_A;

        const G = especie * (tFlex ?? 0) / (1 - (tFlex ?? 0));
        const baseB = brutoReducido + especie + G;
        const retTotB = baseB * (tFlex ?? 0);
        const irpfNomB = retTotB - G;
        netoFlex_B = (B - Canual) - irpfNomB;

        kpiRenting = (ingresoCuentaSel === 'norepercutido') ? netoFlex_B : netoFlex_A;

        document.getElementById('tablaRentingResumen').innerHTML = `
          <tr><td class="hint">Cuota renting anual <span class="hi" data-tip="Cuota mensual × 12. Sacrificio salarial antes de IRPF.">i</span></td><td>− ${fmtEur(Canual)}</td></tr>
          <tr><td>Valoración anual (20% × V)</td><td>${fmtEur(valoracionBase20)}</td></tr>
          <tr><td>Reducción eficiencia aplicada</td><td>${new Intl.NumberFormat('es-ES',{maximumFractionDigits:2}).format(ecoRed*100)} %</td></tr>
          <tr><td>Base tras reducción</td><td>${fmtEur(valoracionAnual)}</td></tr>
          <tr><td>Especie imputable (% uso)</td><td>${fmtEur(especie)}</td></tr>
          <tr class="emph-row"><td><strong>Neto disponible (según opción elegida)</strong></td><td><strong>${fmtEur(kpiRenting)}</strong></td></tr>
        `;
        document.getElementById('tablaRentingDetalle').innerHTML =
          (ingresoCuentaSel === 'norepercutido') ? `
            <tr><td>Bruto reducido</td><td>${fmtEur(brutoReducido)}</td></tr>
            <tr><td class="hint">Ingreso a cuenta (empresa) <span class="hi" data-tip="G = especie × t / (1 − t).">i</span></td><td>${fmtEur(G)}</td></tr>
            <tr><td>Base IRPF (teórica)</td><td>${fmtEur(baseB)}</td></tr>
            <tr><td>Retención total teórica</td><td>${fmtEur(retTotB)}</td></tr>
            <tr><td>Retención desde nómina</td><td>− ${fmtEur(irpfNomB)}</td></tr>
            <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoFlex_B)}</strong></td></tr>
          ` : `
            <tr><td>Bruto reducido</td><td>${fmtEur(brutoReducido)}</td></tr>
            <tr><td>Base IRPF</td><td>${fmtEur(baseA)}</td></tr>
            <tr><td>IRPF (flex)</td><td>− ${fmtEur(irpf_A)}</td></tr>
            <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoFlex_A)}</strong></td></tr>
          `;
      }

      document.getElementById('kpiRenting').textContent = fmtEur(kpiRenting);

      /* ===== ASIDE: comparativa completa ===== */
      document.getElementById('rCompra').textContent = fmtEur(netoCompra);

      // Entrega directa
      document.getElementById('rEntDirRep').textContent   = fmtEur(netEntDirRep);
      document.getElementById('rEntDirNoRep').textContent = fmtEur(netEntDirNoRep);
      // Entrega posterior
      document.getElementById('rEntPosRep').textContent   = fmtEur(netEntPosRep);
      document.getElementById('rEntPosNoRep').textContent = fmtEur(netEntPosNoRep);
      // Renting
      document.getElementById('rFlexRep').textContent = fmtEur(netoFlex_A);
      document.getElementById('rFlexNoRep').textContent = fmtEur(netoFlex_B);

      // Deltas vs compra
      paintDeltaCell(document.getElementById('dEntDirRep'),   netEntDirRep   - netoCompra);
      paintDeltaCell(document.getElementById('dEntDirNoRep'), netEntDirNoRep - netoCompra);
      paintDeltaCell(document.getElementById('dEntPosRep'),   netEntPosRep   - netoCompra);
      paintDeltaCell(document.getElementById('dEntPosNoRep'), netEntPosNoRep - netoCompra);
      paintDeltaCell(document.getElementById('dRep'),         netoFlex_A     - netoCompra);
      paintDeltaCell(document.getElementById('dNoRep'),       netoFlex_B     - netoCompra);
    }

    /* ===== Eventos ===== */
    const inputs = ['B','t','costeCompraMensual','Cmensual','p','V','tFlex','costeAdq','aniosUso','vmEntrega','tEnt'];
    inputs.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', calc);
      el.addEventListener('blur', ()=>{ formatInput(el); calc(); });
      el.addEventListener('focus', ()=>{ unformatOnFocus(el); });
    });
    ['ecoRed','ingresoCuentaSel','ingresoEntregaSel','tipoEntrega','toggleTramos'].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener('change', ()=>{
        if(id==='tipoEntrega'){
          document.getElementById('bloquePosterior').style.display =
            (el.value === 'posterior') ? '' : 'none';
        }
        if(id==='toggleTramos'){
          const useBrackets = el.checked;
          setFlatInputsDisabled(useBrackets);
        }
        calc();
      });
    });

    // Sincronizar tipos con marginal general cuando NO usamos tramos
    const same = document.getElementById('sameAsMarginal');
    const tInput = document.getElementById('t');
    const tFlexInput = document.getElementById('tFlex');
    same.addEventListener('change', ()=>{ if(same.checked){ tFlexInput.value = tInput.value; formatInput(tFlexInput);} calc(); });
    tInput.addEventListener('input', ()=>{ if(same.checked){ tFlexInput.value = tInput.value; calc(); } });

    const sameEnt = document.getElementById('sameAsMarginalEnt');
    const tEntInput = document.getElementById('tEnt');
    sameEnt.addEventListener('change', ()=>{ if(sameEnt.checked){ tEntInput.value = tInput.value; formatInput(tEntInput);} calc(); });
    tInput.addEventListener('input', ()=>{ if(sameEnt.checked){ tEntInput.value = tInput.value; calc(); } });

    // Densidad
    document.getElementById('toggleDensity').addEventListener('change', (e)=>{
      document.body.classList.toggle('compact', e.target.checked);
    });

    // Inicialización
    inputs.forEach(id=>{ const el = document.getElementById(id); if(el) formatInput(el); });
    document.getElementById('bloquePosterior').style.display =
      (document.getElementById('tipoEntrega').value === 'posterior') ? '' : 'none';
    // Por defecto: tramos OFF y tipos habilitados
    setFlatInputsDisabled(false);
    calc();
  </script>
</body>
</html>
