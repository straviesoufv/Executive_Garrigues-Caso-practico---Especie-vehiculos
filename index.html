<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comparador de neto disponible: compra vs renting (flex)</title>

  <style>
    /* ================== Identidad y sistema de diseño ================== */
    :root{
      --ufv-blue-900:#0a2a4a; --ufv-blue-800:#0c3563; --ufv-blue-700:#114a7a; --ufv-blue-600:#165e95;
      --ufv-blue-100:#e9f1fb; --ufv-ink:#0f1720; --ufv-ink-muted:#4b5563; --panel:#ffffff; --bg:#f6f8fc;
      --line:#e5e7eb; --ok:#0f8a41; --bad:#c21f2f; --neu:#6b7280; --shadow:0 6px 18px rgba(10,42,74,.08);
      --radius:14px;

      --space-1:6px; --space-2:10px; --space-3:14px; --space-4:18px; --space-5:24px; --space-6:32px;
      --grid-gap: var(--space-3);
      --block-gap: var(--space-5);
      --control-gap: var(--space-3);
      --table-padding-y: 10px;
      --table-padding-x: 10px;
      --para-lh: 1.45;
    }
    body.compact { --grid-gap:10px; --block-gap:var(--space-4); --control-gap:var(--space-2); --table-padding-y:8px; --table-padding-x:8px; }

    html,body{ margin:0; background:var(--bg); color:var(--ufv-ink); font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, sans-serif; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; }
    .t-title{ font-family:"Times New Roman", Times, serif; letter-spacing:.2px }
    .t-numeral{ font-family:Rockwell,"Segoe UI","Arial Black",Arial,sans-serif; letter-spacing:.2px }
    .wrap{max-width:1280px;margin:auto;padding:22px 16px}

    /* Header */
    .site-header{ background:linear-gradient(0deg, var(--ufv-blue-800), var(--ufv-blue-900)); color:#fff; box-shadow: var(--shadow); }
    .site-header .inner{ max-width:1280px;margin:0 auto;padding:14px 16px; display:flex;align-items:center;gap:16px; justify-content:space-between; }
    .brand{display:flex;align-items:center;gap:14px;text-decoration:none;color:inherit}
    .brand img{height:44px;width:auto;display:block}
    .brand-title{display:flex;flex-direction:column}
    .brand-title h1{margin:0;font-size:22px;font-weight:800}
    .brand-title span{opacity:.9;font-size:13px}

    .view-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .vc-chip{
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(255,255,255,.1); color:#fff; border:1px solid rgba(255,255,255,.25);
      padding:6px 10px; border-radius:999px; font-size:13px; cursor:pointer; user-select:none;
    }
    .vc-chip input{accent-color:#fff}
    .btn{ cursor:pointer; border:none; border-radius:999px; padding:8px 12px; font-weight:700; }
    .btn-primary{ background:#ffffff; color:var(--ufv-blue-800); }
    .btn-ghost{ background:transparent; color:#fff; border:1px solid rgba(255,255,255,.25); }

    /* Hero */
    .hero{background:#fff;border-bottom:1px solid var(--line)}
    .hero .inner{max-width:1280px;margin:0 auto;padding:18px 16px 10px}
    .hero h2{margin:0;font-size:26px;color:var(--ufv-blue-900)}
    .hero p{margin:6px 0 0;color:#1f2937; line-height: var(--para-lh); max-width: 72ch}

    /* Grid + cards */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--grid-gap)}
    .card{ background:var(--panel);border:1px solid var(--line);border-radius:var(--radius); padding:var(--space-4);box-shadow:var(--shadow) }
    .span-12{grid-column:span 12}.span-6{grid-column:span 6}.span-4{grid-column:span 4}
    .span-6.tight{padding:var(--space-3) var(--space-4);}
    h3{margin:0 0 var(--space-3);font-size:18px;color:var(--ufv-blue-900)}

    label{display:block;font-size:13px;color:var(--ufv-ink-muted);margin:var(--control-gap) 0 6px}
    input,select{ width:100%;box-sizing:border-box;background:#fff;color:#000; border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:15px; outline:none;transition:border .15s, box-shadow .15s }
    input:focus,select:focus{ border-color:var(--ufv-blue-600); box-shadow:0 0 0 3px color-mix(in srgb, var(--ufv-blue-600) 20%, transparent); }
    table{width:100%;border-collapse:collapse;margin-top:var(--space-2)}
    td{ padding:var(--table-padding-y) var(--table-padding-x); border-bottom:1px solid var(--line); text-align:right;font-variant-numeric:tabular-nums }
    tr:nth-child(even) td{ background:#fafbfc } td:first-child{text-align:left;color:#334155}
    .table-compact td{padding:6px 8px}
    .kpi{font-size:28px;font-weight:800;margin:var(--space-2) 0}
    .pill{display:inline-block;border:1px solid #cbd5e1;border-radius:999px;padding:2px 8px;font-size:12px;color:#334155;background:var(--ufv-blue-100)}
    .good{color:var(--ok)} .bad{color:var(--bad)} .neu{color:var(--neu)}
    .muted{color:var(--ufv-ink-muted)}
    .result{font-size:30px;font-weight:900;margin:6px 0}
    .hint{display:inline-flex;align-items:center;gap:6px}
    .hi{display:inline-block;width:18px;height:18px;line-height:18px;text-align:center;border:1px solid #cbd5e1;border-radius:50%;font-size:11px;color:#1f2937;cursor:help;position:relative;background:#fff}
    .hi:hover::after{content:attr(data-tip); position:absolute; left:50%; transform:translateX(-50%); bottom:135%; max-width:520px; min-width:280px; line-height:var(--para-lh); background:#fff; color:#0f1720; border:1px solid var(--line); padding:10px 12px; border-radius:10px; white-space:normal; z-index:5; box-shadow:var(--shadow)}
    .hi:hover::before{content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:124%;border:7px solid transparent;border-top-color:var(--line)}
    tr:hover td { background:#f6f8fb }
    details{margin-top:var(--space-3); border-top:1px solid var(--line); padding-top:var(--space-2)}
    summary{ list-style:none; cursor:pointer; font-weight:700; color:var(--ufv-blue-900); display:flex; align-items:center; gap:8px; }
    summary::-webkit-details-marker{display:none}
    summary::before{ content:"▸"; transition: transform .2s; font-size:14px; color:var(--ufv-blue-900); }
    details[open] summary::before{ transform: rotate(90deg) }
    .overline{ color: var(--ufv-ink-muted); font-size:12px; letter-spacing:.08em; text-transform:uppercase; margin-top: var(--space-3) }
    .layout{display:grid;grid-template-columns: 1fr 420px;gap:var(--grid-gap);align-items:start; margin-top: var(--block-gap)}
    .aside-sticky{position:sticky;top:16px}
    @media (max-width:1024px){ .layout{grid-template-columns:1fr} .aside-sticky{position:static} }
    .card > details{ border-top:none; padding-top:0; margin-top:0 }
    .card summary{ margin:-6px -6px var(--space-2); padding:8px 6px; border-radius:10px; }
    .card summary:hover{ background:#f8fafc }
    .emph-row td{ font-weight:800; font-size:16px; background:#f1f5f9 } .emph-row td:first-child{ letter-spacing:.2px }
    .site-footer{color:var(--ufv-ink-muted);font-size:12px;padding:18px 0 28px;text-align:center}

    /* ===== Modal de configuración ===== */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(15,23,32,.45);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:50;
    }
    .modal{ background:#fff; border-radius:16px; width:min(960px, 96vw); max-height:90vh; overflow:auto;
      box-shadow:0 24px 64px rgba(0,0,0,.25); border:1px solid var(--line); }
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .modal-header h4{margin:0;font-size:18px;color:var(--ufv-blue-900)}
    .modal-body{padding:16px}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:14px 16px;border-top:1px solid var(--line)}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);margin-bottom:10px}
    .tab-btn{background:#f3f5f9;border:1px solid var(--line);padding:8px 10px;border-radius:8px 8px 0 0;cursor:pointer;font-weight:700}
    .tab-btn.active{background:#fff;border-bottom-color:#fff;color:var(--ufv-blue-900)}
    .tab-panel{display:none}
    .tab-panel.active{display:block}
    .table-config th, .table-config td{ text-align:left; padding:8px; border-bottom:1px solid var(--line) }
    .table-config input[type="text"]{ width:100%; padding:8px; border-radius:8px; border:1px solid var(--line) }
    .row-actions button{ border:none; background:transparent; color:#0f1720; cursor:pointer; padding:6px 8px; border-radius:6px }
    .row-actions button:hover{ background:#eef2f7 }
    .help{ font-size:12px; color:#4b5563; }
  </style>
</head>
<body>
  <!-- Cabecera -->
  <header class="site-header">
    <div class="inner">
      <a class="brand" href="#">
        <img id="ufvLogo" src="./logo-UFV-blanco.png" alt="UFV" onerror="this.onerror=null; this.src='./logo-UFV.png';">
        <div class="brand-title">
          <h1 class="t-title">CASO PRÁCTICO</h1>
          <span>Comparador de neto disponible · compra vs renting (flex)</span>
        </div>
      </a>

      <div class="view-controls" aria-label="Preferencias de visualización">
<!--         <label class="vc-chip" title="Aumenta o reduce espacios y padding">
          <input id="toggleDensity" type="checkbox"> Densidad compacta
        </label> -->
        <label class="vc-chip" title="Aplicar tramos de IRPF en lugar de tipo fijo">
          <input id="toggleTramos" type="checkbox"> Calcular con tramos
        </label>
        <button id="expandAll" class="vc-chip" type="button" title="Mostrar todos los escenarios">Expandir todo</button>
        <button id="collapseAll" class="vc-chip" type="button" title="Ocultar todos los escenarios">Contraer todo</button>
        <button id="openConfig" class="btn btn-primary" type="button" title="Configurar tramos y descuentos">Configuración</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero">
    <div class="inner">
      <h2 class="t-title">Caso práctico de compensación - Máster Executive Garrigues 2025</h2>
      <p>Simula el neto disponible al comprar un vehículo por tu cuenta, por renting vía retribución flexible o por entrega en propiedad (retribución en especie).</p>
    </div>
  </section>

  <div class="wrap">
    <div class="layout">
      <!-- MAIN -->
      <main class="grid">
        <!-- Salario -->
        <div class="card span-12">
          <h3 class="t-title">Salario e impuestos</h3>
          <div class="grid">
            <div class="span-6">
              <label for="B">Retribución fija bruta anual (€)</label>
              <input id="B" type="text" value="40000 €" data-type="eur" />
            </div>
            <div class="span-6">
              <label for="t">Tipo marginal IRPF (%) <span class="hi" data-tip="Solo se usa si 'Calcular con tramos' está desactivado.">i</span></label>
              <input id="t" type="text" value="25 %" data-type="pct" />
            </div>
          </div>
        </div>

        <!-- Compra -->
        <div class="card span-6">
          <details>
            <summary><h3 class="t-title" style="margin:0">Compra por su cuenta</h3></summary>
            <label for="costeCompraMensual">Coste mensual estimado del coche (€)</label>
            <input id="costeCompraMensual" type="text" value="590 €" data-type="eur" />
            <p class="overline">KPI</p>
            <p class="kpi t-numeral" id="kpiCompra">—</p>
            <details><summary>Resumen</summary><table><tbody id="tablaCompraResumen"></tbody></table></details>
            <details><summary>Detalle del cálculo</summary><table><tbody id="tablaCompraDetalle"></tbody></table></details>
          </details>
        </div>

        <!-- Entrega en propiedad -->
        <div class="card span-6 tight">
          <details>
            <summary><h3 class="t-title" style="margin:0">Entrega del vehículo en propiedad</h3></summary>

            <label for="tipoEntrega">Tipo de entrega</label>
            <select id="tipoEntrega">
              <option value="directa">Entrega directa (sin uso previo)</option>
              <option value="posterior">Uso previo y posterior entrega</option>
            </select>

            <label for="costeAdq">Coste de adquisición para el empleador (€) <span class="hi" data-tip="Incluye IVA, IEDMT y gastos.">i</span></label>
            <input id="costeAdq" type="text" value="30000 €" data-type="eur" />

            <div id="bloquePosterior" style="display:none">
              <label for="aniosUso">Años de uso antes de la entrega</label>
              <input id="aniosUso" type="text" value="3" data-type="num" />
              <label for="vmEntrega">Valor de mercado en la fecha de entrega (€)</label>
              <input id="vmEntrega" type="text" value="20000 €" data-type="eur" />
            </div>

            <div class="grid" style="margin-top:var(--control-gap)">
              <div class="span-6">
                <label for="tEnt">Tipo IRPF (entrega) (%) <span class="hi" data-tip="Solo se usa si 'Calcular con tramos' está desactivado.">i</span></label>
                <input id="tEnt" type="text" value="25 %" data-type="pct" />
              </div>
              <div class="span-6" style="display:flex;align-items:end;gap:8px;padding-bottom:6px">
                <input id="sameAsMarginalEnt" type="checkbox" checked aria-describedby="sameEntLbl">
                <label id="sameEntLbl" for="sameAsMarginalEnt" style="margin:0;">Igual que el tipo marginal general</label>
              </div>
            </div>

            <label for="ingresoEntregaSel">Ingreso a cuenta de la entrega</label>
            <select id="ingresoEntregaSel">
              <option value="repercutido">Repercutido al trabajador</option>
              <option value="norepercutido">No repercutido (lo asume la empresa)</option>
            </select>

            <p class="overline">KPI</p>
            <p class="kpi t-numeral" id="kpiEntrega">—</p>
            <div id="entregaWarning" style="display:none; margin-top:10px; padding:8px;
              background:#FEF3C7; border:1px solid #F59E0B; color:#92400E;
              border-radius:6px; font-size:13px;">
            </div>            
            <details><summary>Resumen de la entrega</summary><table><tbody id="tablaEntregaResumen"></tbody></table></details>
            <details><summary>Detalle de retenciones (entrega)</summary><table><tbody id="tablaEntregaDetalle"></tbody></table></details>
          </details>
        </div>

        <!-- Renting flex -->
        <div class="card span-6">
          <details>
            <summary><h3 class="t-title" style="margin:0">Renting vía retribución flexible</h3></summary>
            <label for="Cmensual">Cuota renting mensual (€)</label>
            <input id="Cmensual" type="text" value="620 €" data-type="eur" />
            <label for="p">% de uso privativo</label>
            <input id="p" type="text" value="40 %" data-type="pct" />
            <label for="V">Valor de mercado del vehículo para AEAT (€) <span class="hi" data-tip="La AEAT toma el 20% anual de este valor.">i</span></label>
            <input id="V" type="text" value="30000 €" data-type="eur" />

            <label for="ecoRed">Reducción eficiencia (art. 48 bis RIRPF)</label>
            <select id="ecoRed" aria-label="Reducción por eficiencia energética"></select>

            <div class="grid" style="margin-top:var(--control-gap)">
              <div class="span-6">
                <label for="tFlex">Tipo IRPF (flex) (%) <span class="hi" data-tip="Solo se usa si 'Calcular con tramos' está desactivado.">i</span></label>
                <input id="tFlex" type="text" value="25 %" data-type="pct" />
              </div>
              <div class="span-6" style="display:flex;align-items:end;gap:8px;padding-bottom:6px">
                <input id="sameAsMarginal" type="checkbox" checked aria-describedby="samelabel">
                <label id="samelabel" for="sameAsMarginal" style="margin:0;">Igual que el tipo marginal general</label>
              </div>
            </div>

            <label for="ingresoCuentaSel">Ingreso a cuenta de la especie</label>
            <select id="ingresoCuentaSel" aria-label="Ingreso a cuenta">
              <option value="repercutido">Repercutido al trabajador</option>
              <option value="norepercutido">No repercutido (lo asume la empresa)</option>
            </select>

            <p class="overline">KPI</p>
            <p class="kpi t-numeral" id="kpiRenting">—</p>
            <details><summary>Resumen fiscal</summary><table><tbody id="tablaRentingResumen"></tbody></table></details>
            <details><summary>Detalle de retenciones</summary><table><tbody id="tablaRentingDetalle"></tbody></table></details>
          </details>
        </div>

        <div id="rentingWarning" style="display:none; margin-top:10px; padding:8px;
          background:#FEF3C7; border:1px solid #F59E0B; color:#92400E;
          border-radius:6px; font-size:13px;">
        </div>

      </main>

      <!-- ASIDE -->
      <aside class="aside-sticky">
        <div class="card">
          <h3 class="t-title">Resultado</h3>
          
          <label for="tipoResultado" style="margin-top:8px">Mostrar resultados</label>
          <select id="tipoResultado" style="margin-bottom:12px">
            <option value="repercutido">Repercutidos</option>
            <option value="norepercutido">No repercutidos</option>
          </select>

          <table class="table-compact" style="margin-top:4px">
            <tbody id="tablaResumen">
              <tr data-row-type="compra"><td>Compra por su cuenta</td><td style="text-align:right" id="rCompra">—</td></tr>
              <tr data-row-type="repercutido"><td>Entrega directa</td><td style="text-align:right" id="rEntDirRep">—</td></tr>
              <tr data-row-type="norepercutido" style="display:none;"><td>Entrega directa</td><td style="text-align:right" id="rEntDirNoRep">—</td></tr>
              <tr data-row-type="repercutido"><td>Entrega posterior</td><td style="text-align:right" id="rEntPosRep">—</td></tr>
              <tr data-row-type="norepercutido" style="display:none;"><td>Entrega posterior</td><td style="text-align:right" id="rEntPosNoRep">—</td></tr>
              <tr data-row-type="repercutido"><td>Renting flex</td><td style="text-align:right" id="rFlexRep">—</td></tr>
              <tr data-row-type="norepercutido" style="display:none;"><td>Renting flex</td><td style="text-align:right" id="rFlexNoRep">—</td></tr>
              <tr class="emph-row" data-row-type="repercutido"><td>Diferencia vs compra · Entrega directa</td><td style="text-align:right" id="dEntDirRep">—</td></tr>
              <tr class="emph-row" data-row-type="norepercutido" style="display:none;"><td>Diferencia vs compra · Entrega directa</td><td style="text-align:right" id="dEntDirNoRep">—</td></tr>
              <tr class="emph-row" data-row-type="repercutido"><td>Diferencia vs compra · Entrega posterior</td><td style="text-align:right" id="dEntPosRep">—</td></tr>
              <tr class="emph-row" data-row-type="norepercutido" style="display:none;"><td>Diferencia vs compra · Entrega posterior</td><td style="text-align:right" id="dEntPosNoRep">—</td></tr>
              <tr class="emph-row" data-row-type="repercutido"><td>Diferencia vs compra · Renting</td><td style="text-align:right" id="dRep">—</td></tr>
              <tr class="emph-row" data-row-type="norepercutido" style="display:none;"><td>Diferencia vs compra · Renting</td><td style="text-align:right" id="dNoRep">—</td></tr>
            </tbody>
          </table>

          <div style="margin:16px 0; text-align:center">
            <a href="https://notebooklm.google.com/notebook/64643cca-c6ac-43ac-9c79-a8525b5cb14b"
               target="_blank" rel="noopener noreferrer" aria-label="Abrir NotebookLM con documentación del caso"
               style="display:inline-block; background:var(--ufv-blue-700); color:#fff;
                      padding:10px 16px; border-radius:8px; font-weight:700; text-decoration:none;
                      box-shadow:var(--shadow); transition:background .2s">
              💬 Pregunta sobre la ley
            </a>
          </div>

          <details style="margin-top:14px">
            <summary>Referencia AEAT y resumen</summary>
            <div style="margin-top:10px; font-size:13px; color:#334155">
              <p style="margin:6px 0 10px">
                <a href="https://sede.agenciatributaria.gob.es/Sede/ayuda/manuales-videos-folletos/manuales-practicos/irpf-2024/c03-rendimientos-trabajo/rendimientos-trabajo-especie/computo-rendimientos-trabajo-especie/reglas-especiales/entrega-utilizacion-vehiculos-automoviles.html" target="_blank" rel="noopener noreferrer">
                  Página oficial · AEAT · Entrega o utilización de vehículos automóviles
                </a>
              </p>
              <ul style="margin:0 0 10px 18px; padding:0; line-height:1.45">
                <li><strong>Entrega</strong>: coste de adquisición para el empleador + impuestos y gastos; si hubo uso previo: VM en fecha − 20% anual ya imputado.</li>
                <li><strong>Utilización</strong>: propiedad empresa → 20% anual × coste; no propiedad → 20% anual × VM nuevo.</li>
                <li><em>Incluye</em> seguros/IVTM/mantenimiento; <em>no</em> incluye combustible.</li>
                <li>Uso mixto: imputar por <strong>disponibilidad para uso particular</strong> (% privado).</li>
                <li><strong>Reducciones eco (art. 48 bis RIRPF)</strong>: −15% / −20% / −30% con límites de precio sin impuestos.</li>
              </ul>
            </div>
          </details>
        </div>
      </aside>
    </div>

    <footer class="site-footer">Sergio Travieso · UFV · 2025</footer>
  </div>

  <!-- ===== Modal de configuración ===== -->
  <div id="configModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="configTitle">
    <div class="modal">
      <div class="modal-header">
        <h4 id="configTitle" class="t-title">Configuración</h4>
        <button id="closeConfig" class="btn btn-ghost" type="button" aria-label="Cerrar">✕</button>
      </div>
      <div class="modal-body">
        <div class="tabs">
          <button class="tab-btn active" data-tab="tab-tramos" type="button">IRPF por tramos</button>
          <button class="tab-btn" data-tab="tab-eco" type="button">Vehículos eficientes</button>
        </div>

        <!-- Panel: Tramos -->
        <div id="tab-tramos" class="tab-panel active">
          <p class="help">Edita los tramos. El último se interpretará como “en adelante”. Orden ascendente, tipos en %.</p>
          <table class="table-config" id="tablaTramos">
            <thead><tr><th>Hasta (€)</th><th>Tipo (%)</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div style="margin-top:10px"><button id="addTramo" type="button" class="btn">Añadir tramo</button></div>
        </div>

        <!-- Panel: Eco -->
        <div id="tab-eco" class="tab-panel">
          <p class="help">Define los presets que aparecen en “Reducción eficiencia”. Puedes activar/desactivar, editar texto y %.</p>
          <table class="table-config" id="tablaEco">
            <thead><tr><th style="width:36px">On</th><th>Etiqueta</th><th style="width:140px">Reducción (%)</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div style="margin-top:10px"><button id="addEco" type="button" class="btn">Añadir preset</button></div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="resetConfig" class="btn" type="button" title="Volver a valores por defecto">Restablecer</button>
        <button id="saveConfig" class="btn btn-primary" type="button">Guardar cambios</button>
      </div>
    </div>
  </div>

<script>
  /* ===== Helpers formato/parseo ===== */
  const fmtEur = v => new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:2}).format(v);
  function parseLocaleNumber(input){
    if(typeof input !== 'string') input = String(input ?? '');
    let s = input.trim(); if(!s) return 0;
    const neg = /^-/.test(s) ? -1 : 1;
    s = s.replace(/[^0-9.,]/g,''); if(!s) return 0;
    const lastComma = s.lastIndexOf(','), lastDot = s.lastIndexOf('.'); const decPos = Math.max(lastComma,lastDot);
    if(decPos >= 0){
      const intPart = s.slice(0, decPos).replace(/[.,]/g,'');
      const fracPart = s.slice(decPos+1).replace(/[.,]/g,'');
      return neg * parseFloat((intPart || '0') + '.' + (fracPart || '0'));
    }
    return neg * parseFloat(s.replace(/[.,]/g,''));
  }
  function getNum(id){ const el=document.getElementById(id); return el ? parseLocaleNumber(el.value) : 0; }
  function getSelNum(id){ return Number(document.getElementById(id).value) || 0; }
  function formatInput(el){
    const t = el.dataset.type; const num = getNum(el.id);
    if(t==='eur') el.value = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:2}).format(num);
    else if(t==='pct') el.value = new Intl.NumberFormat('es-ES',{maximumFractionDigits:2}).format(num) + ' %';
    else el.value = new Intl.NumberFormat('es-ES',{maximumFractionDigits:2}).format(num);
  }
  function unformatOnFocus(el){
    const val = getNum(el.id);
    if(el.dataset.type==='pct'){ el.value = String(val).replace('.',','); } else { el.value = String(val); }
  }
  function paintDeltaCell(td, value){
    td.classList.remove('good','bad','neu');
    if(value>0) td.classList.add('good'); else if(value<0) td.classList.add('bad'); else td.classList.add('neu');
    td.textContent = (value>=0?'+':'') + fmtEur(value);
  }

  // ===== Filtro resumen (repercutidos / no repercutidos) =====
  function filterResumen(){
    const sel = document.getElementById('tipoResultado');
    if(!sel) return;
    const mode = sel.value; // 'repercutido' | 'norepercutido'
    const rows = document.querySelectorAll('#tablaResumen tr');
    rows.forEach(tr => {
      const t = tr.getAttribute('data-row-type');
      if (t === 'compra' || t === mode) {
        tr.style.display = '';
      } else if (t === 'repercutido' || t === 'norepercutido') {
        tr.style.display = 'none';
      } else {
        tr.style.display = '';
      }
    });
  }

  /* ===== Config editable ===== */
  const DEFAULT_TAX_TABLE = [
    [12450, 0.19],[20200, 0.24],[35200, 0.30],[60000, 0.37],[300000, 0.45],[Infinity, 0.47]
  ];
  const DEFAULT_ECO = [
    {enabled:true,  label:'Sin reducción (0%)', value:0},
    {enabled:true,  label:'15% · Euro 6, ≤120 g CO₂ y ≤25.000 € sin impuestos', value:0.15},
    {enabled:true,  label:'20% · Euro 6 + híbrido/GLP/GN, ≤35.000 € sin impuestos', value:0.20},
    {enabled:true,  label:'30% · BEV/E-REV/PHEV (≥15 km), ≤40.000 € sin impuestos', value:0.30}
  ];
  let TAX_TABLE = JSON.parse(JSON.stringify(DEFAULT_TAX_TABLE));
  let ECO_PRESETS = JSON.parse(JSON.stringify(DEFAULT_ECO));

  /* ===== IRPF por tramos + solver G ===== */
  function taxByBrackets(base, table=TAX_TABLE){
    base = Math.max(0, base || 0);
    let prev=0, tax=0;
    for(const [limit, rate] of table){
      const top = isFinite(limit) ? limit : base;
      const span = Math.min(base, top) - prev;
      if(span>0){ tax += span * rate; prev += span; }
      if(base <= top) break;
    }
    return tax;
  }
  function solveG_bisection(base0, extra, table=TAX_TABLE){
    const f = (G) => taxByBrackets(base0 + extra + G, table) - taxByBrackets(base0, table) - G;
    let lo=0, hi = Math.max(1000, Math.abs(extra) * 1.0);
    let fhi=f(hi), guard=0;
    while(fhi<0 && guard<30){ hi*=2; fhi=f(hi); guard++; }
    if(fhi<0) return 0;
    for(let i=0;i<60;i++){
      const mid=0.5*(lo+hi), fm=f(mid);
      if(Math.abs(fm)<1e-7) return mid;
      if(fm<0) lo=mid; else hi=mid;
    }
    return 0.5*(lo+hi);
  }

  /* ===== Info de tramo aplicable y formato % ===== */
  function getBracketInfo(base, table=TAX_TABLE){
    base = Math.max(0, base || 0);
    let prev = 0;
    for (const [limit, rate] of table){
      const top = isFinite(limit) ? limit : Infinity;
      if (base <= top) return { rate, from: prev, to: top }; // rate 0–1
      prev = top;
    }
    const [_, r] = table[table.length-1];
    return { rate: r, from: prev, to: Infinity };
  }
  const fmtPct0 = x => new Intl.NumberFormat('es-ES',{maximumFractionDigits:0}).format(x*100)+' %';



  /* ===== UI: eco select ===== */
  function populateEcoSelect(){
    const sel = document.getElementById('ecoRed');
    const current = Number(sel.value) || 0;
    sel.innerHTML = '';
    ECO_PRESETS.filter(p=>p.enabled).forEach(p=>{
      const opt = document.createElement('option');
      opt.value = String(p.value);
      opt.textContent = p.label;
      sel.appendChild(opt);
    });
    const found = Array.from(sel.options).find(o => Number(o.value) === current);
    if(found) sel.value = String(current);
  }

  /* ===== Expand/Collapse ===== */
  document.getElementById('expandAll').addEventListener('click', ()=>{ document.querySelectorAll('.card > details').forEach(d=>d.open=true); });
  document.getElementById('collapseAll').addEventListener('click', ()=>{ document.querySelectorAll('.card > details').forEach(d=>d.open=false); });

  /* ===== Cálculo ===== */
  function calc(){
    const B = getNum('B');
    const useBrackets = document.getElementById('toggleTramos').checked;

    // Reset de warnings (evita que se “queden”):
    const entregaWarn = document.getElementById('entregaWarning');
    const rentingWarn = document.getElementById('rentingWarning');
    if (entregaWarn){ entregaWarn.style.display='none'; entregaWarn.textContent=''; }
    if (rentingWarn){ rentingWarn.style.display='none'; rentingWarn.textContent=''; }

    // Helper warning 30%
    function checkEspecieLimit(especie, baseSalarial, targetId){
      const warningBox = document.getElementById(targetId);
      if (!warningBox) return;
      if (especie > 0.30 * baseSalarial) {
        warningBox.style.display = 'block';
        warningBox.textContent = `⚠️ Atención: la retribución en especie (${fmtEur(especie)}) supera el 30% del salario bruto (${fmtEur(baseSalarial)}).`;
      } else {
        warningBox.style.display = 'none';
        warningBox.textContent = '';
      }
    }

    // ===== Compra
    const t = useBrackets ? null : getNum('t')/100;
    const costeCompraAnual = getNum('costeCompraMensual')*12;
    const taxCompra = useBrackets ? taxByBrackets(B) : B*(t??0);
    const netoSinCoche = B - taxCompra;
    const netoCompra = netoSinCoche - costeCompraAnual;
    const avgCompraPct = useBrackets && B>0 ? (taxCompra/B*100) : null;

    document.getElementById('kpiCompra').textContent = fmtEur(netoCompra);
    document.getElementById('tablaCompraResumen').innerHTML = `
      <tr><td>Neto sin coche</td><td>${fmtEur(netoSinCoche)}</td></tr>
      <tr><td>Coste anual coche</td><td>− ${fmtEur(costeCompraAnual)}</td></tr>
      <tr class="emph-row"><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoCompra)}</strong></td></tr>`;
    document.getElementById('tablaCompraDetalle').innerHTML = `
      <tr><td>Bruto anual</td><td>${fmtEur(B)}</td></tr>
      <tr><td>${useBrackets?`Cuota por tramos (${avgCompraPct?.toFixed(2)}%)`:'IRPF (marginal fijo)'}</td><td>− ${fmtEur(taxCompra)}</td></tr>
      <tr><td>Neto sin coche</td><td>${fmtEur(netoSinCoche)}</td></tr>
      <tr><td>Coste anual coche</td><td>− ${fmtEur(costeCompraAnual)}</td></tr>
      <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoCompra)}</strong></td></tr>`;

    // ===== Entrega en propiedad
    const tipoEntrega = document.getElementById('tipoEntrega').value; // directa | posterior
    const costeAdq    = getNum('costeAdq');
    const aniosUso    = getNum('aniosUso');
    const vmEntrega   = getNum('vmEntrega');
    const tEnt        = useBrackets ? null : getNum('tEnt')/100;
    const ingresoEntregaSel = document.getElementById('ingresoEntregaSel').value;

    const valorEntregaDir = costeAdq;
    const valoracionUsoAcum = 0.20 * costeAdq * (isFinite(aniosUso) ? aniosUso : 0);
    const valorEntregaPos = Math.max(0, vmEntrega - valoracionUsoAcum);
    const valorEntregaSel = (tipoEntrega==='directa') ? valorEntregaDir : valorEntregaPos;
    // warning entrega: la "especie" es el valor de entrega seleccionado
    checkEspecieLimit(valorEntregaSel, B, 'entregaWarning');



    function netoEntrega(valor, repercutido){
      if(useBrackets){
        if(repercutido){
          return B - taxByBrackets(B + valor);
        }else{
          const G = solveG_bisection(B, valor);
          const taxDiff = taxByBrackets(B + valor + G) - taxByBrackets(B);
          return B - (taxDiff - G);
        }
      }else{
        if(repercutido){
          return B - (B + valor)*(tEnt ?? 0);
        }else{
          const G = valor*(tEnt ?? 0)/(1-(tEnt ?? 0));
          const retTot = (B + valor + G)*(tEnt ?? 0);
          return B - (retTot - G);
        }
      }
    }

    const netEntDirRep   = netoEntrega(valorEntregaDir, true);
    const netEntDirNoRep = netoEntrega(valorEntregaDir, false);
    const netEntPosRep   = netoEntrega(valorEntregaPos, true);
    const netEntPosNoRep = netoEntrega(valorEntregaPos, false);

const netoEntregaMostrar =
  (ingresoEntregaSel==='norepercutido')
    ? netoEntrega(valorEntregaSel,false)
    : netoEntrega(valorEntregaSel,true);

document.getElementById('kpiEntrega').textContent = fmtEur(netoEntregaMostrar);
document.getElementById('tablaEntregaResumen').innerHTML = `
  <tr><td>Tipo de entrega</td><td>${tipoEntrega==='directa'?'Directa (sin uso previo)':'Uso previo y posterior entrega'}</td></tr>
  <tr><td>Valoración de entrega</td><td>${fmtEur(valorEntregaSel)}</td></tr>
  <tr class="emph-row"><td><strong>Neto disponible (según opción elegida)</strong></td><td><strong>${fmtEur(netoEntregaMostrar)}</strong></td></tr>`;

// Detalle
if (ingresoEntregaSel === 'norepercutido') {
  if (useBrackets){
    const G = solveG_bisection(B, valorEntregaSel);
    const baseTheo = B + valorEntregaSel + G;
    const { rate: tramoTheo } = getBracketInfo(baseTheo);
    const taxDiff = taxByBrackets(baseTheo) - taxByBrackets(B);
    document.getElementById('tablaEntregaDetalle').innerHTML = `
      <tr><td>Ingreso a cuenta (empresa)</td><td>${fmtEur(G)}</td></tr>
      <tr><td>Base IRPF teórica = B + entrega + G</td><td>${fmtEur(baseTheo)}</td></tr>
      <tr><td>Retención total (por tramos, ${fmtPct0(tramoTheo)})</td><td>${fmtEur(taxTheo)}</td></tr>
      <tr><td>Retención desde nómina</td><td>− ${fmtEur(taxDiff - G)}</td></tr>
      <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoEntregaMostrar)}</strong></td></tr>`;
  } else {
    const G = valorEntregaSel*(tEnt ?? 0)/(1-(tEnt ?? 0));
    const retTot = (B + valorEntregaSel + G)*(tEnt ?? 0);
    document.getElementById('tablaEntregaDetalle').innerHTML = `
      <tr><td>Ingreso a cuenta (empresa)</td><td>${fmtEur(G)}</td></tr>
      <tr><td>Retención total (tipo fijo ${fmtPct0(tEnt ?? 0)})</td><td>${fmtEur(retTot)}</td></tr>
      <tr><td>Retención desde nómina</td><td>− ${fmtEur(retTot - G)}</td></tr>
      <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoEntregaMostrar)}</strong></td></tr>`;
  }
} else {
  const baseEnt = B + valorEntregaSel;
  if (useBrackets){
    const { rate: tramoEnt } = getBracketInfo(baseEnt);
    const quota = taxByBrackets(baseEnt);
    document.getElementById('tablaEntregaDetalle').innerHTML = `
      <tr><td>Base IRPF</td><td>${fmtEur(baseEnt)}</td></tr>
      <tr><td>Cuota por tramos (${fmtPct0(tramoEnt)})</td><td>− ${fmtEur(quota)}</td></tr>
      <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoEntregaMostrar)}</strong></td></tr>`;
  } else {
    const quota = baseEnt * (tEnt ?? 0);
    document.getElementById('tablaEntregaDetalle').innerHTML = `
      <tr><td>Base IRPF</td><td>${fmtEur(baseEnt)}</td></tr>
      <tr><td>IRPF (tipo fijo ${fmtPct0(tEnt ?? 0)})</td><td>− ${fmtEur(quota)}</td></tr>
      <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoEntregaMostrar)}</strong></td></tr>`;
  }
}


    // ===== Renting
    const Cmens = getNum('Cmensual'), Canual = Cmens * 12;
    const p = getNum('p') / 100;
    const V = getNum('V');
    const ecoRed = getSelNum('ecoRed');
    const especie = (0.20 * V) * (1 - ecoRed) * p;     // especie sólo renting
    const brutoReducido = B - Canual;
    const tFlex = useBrackets ? null : getNum('tFlex') / 100;
    const ingresoCuentaSel = document.getElementById('ingresoCuentaSel').value;

    // Warning renting (independiente del de entrega)
    checkEspecieLimit(especie, B, 'rentingWarning');


    let netoFlex_A, netoFlex_B;

    if (useBrackets) {
      const baseA = brutoReducido + especie;
      const taxA = taxByBrackets(baseA);
      const { rate: tramoA } = getBracketInfo(baseA);

      netoFlex_A = (B - Canual) - taxA;

      const G = solveG_bisection(brutoReducido, especie);
      const baseTheo = brutoReducido + especie + G;
      const taxTheo = taxByBrackets(baseTheo);
      const taxDiff = taxTheo - taxByBrackets(brutoReducido);
      const { rate: tramoTheo } = getBracketInfo(baseTheo);
      netoFlex_B = (B - Canual) - (taxDiff - G);

      document.getElementById('tablaRentingResumen').innerHTML = `
        <tr><td>Cuota renting anual</td><td>− ${fmtEur(Canual)}</td></tr>
        <tr><td>Valoración anual (20% × V)</td><td>${fmtEur(0.20 * V)}</td></tr>
        <tr><td>Reducción eficiencia aplicada</td><td>${(ecoRed * 100).toFixed(2)} %</td></tr>
        <tr><td>Especie imputable</td><td>${fmtEur(especie)}</td></tr>
        <tr><td class="hint">Nota <span class="hi" data-tip="La especie no es dinero que cobres: solo incrementa la base para calcular el IRPF. El neto parte del sueldo tras restar la cuota de renting.">i</span></td><td>No dineraria</td></tr>
        <tr class="emph-row"><td><strong>Neto disponible (según opción elegida)</strong></td><td><strong>${fmtEur(ingresoCuentaSel === 'norepercutido' ? netoFlex_B : netoFlex_A)}</strong></td></tr>
      `;

      if (ingresoCuentaSel === 'norepercutido') {
        document.getElementById('tablaRentingDetalle').innerHTML =
          `<tr><td>Bruto reducido (B − C)</td><td>${fmtEur(brutoReducido)}</td></tr>
           <tr><td>Ingreso a cuenta (empresa)</td><td>${fmtEur(G)}</td></tr>
           <tr><td>Base IRPF teórica = B − C + especie + G</td><td>${fmtEur(baseTheo)}</td></tr>
           <tr><td>Retención total (por tramos, ${avgTheo.toFixed(2)}%)</td><td>${fmtEur(taxTheo)}</td></tr>
           <tr><td>Retención desde nómina</td><td>− ${fmtEur(taxDiff - G)}</td></tr>
           <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoFlex_B)}</strong></td></tr>`;
      } else {
        document.getElementById('tablaRentingDetalle').innerHTML =
          `<tr><td>Bruto reducido (B − C)</td><td>${fmtEur(brutoReducido)}</td></tr>
           <tr><td>Base IRPF = B − C + especie</td><td>${fmtEur(baseA)}</td></tr>
           <tr><td>Cuota por tramos (${fmtPct0(tramoA)})</td><td>− ${fmtEur(taxA)}</td></tr>
           <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoFlex_A)}</strong></td></tr>`;
      }

    } else {
      const baseA = brutoReducido + especie;
      const irpfA = baseA * (tFlex ?? 0);
      netoFlex_A = (B - Canual) - irpfA;

      const G = especie * (tFlex ?? 0) / (1 - (tFlex ?? 0));
      const retTot = (brutoReducido + especie + G) * (tFlex ?? 0);
      netoFlex_B = (B - Canual) - (retTot - G);

      document.getElementById('tablaRentingResumen').innerHTML = `
        <tr><td>Cuota renting anual</td><td>− ${fmtEur(Canual)}</td></tr>
        <tr><td>Valoración anual (20% × V)</td><td>${fmtEur(0.20 * V)}</td></tr>
        <tr><td>Reducción eficiencia aplicada</td><td>${(ecoRed * 100).toFixed(2)} %</td></tr>
        <tr><td>Especie imputable</td><td>${fmtEur(especie)}</td></tr>
        <tr><td class="hint">Nota <span class="hi" data-tip="La especie no es dinero que cobres: solo incrementa la base para calcular el IRPF. El neto parte del sueldo tras restar la cuota de renting.">i</span></td><td>No dineraria</td></tr>
        <tr class="emph-row"><td><strong>Neto disponible (según opción elegida)</strong></td><td><strong>${fmtEur(ingresoCuentaSel === 'norepercutido' ? netoFlex_B : netoFlex_A)}</strong></td></tr>
      `;

      if (ingresoCuentaSel === 'norepercutido') {
        document.getElementById('tablaRentingDetalle').innerHTML =
          `<tr><td>Bruto reducido (B − C)</td><td>${fmtEur(brutoReducido)}</td></tr>
           <tr><td>Ingreso a cuenta (empresa)</td><td>${fmtEur(G)}</td></tr>
           <tr><td>Base IRPF teórica = B − C + especie + G</td><td>${fmtEur(brutoReducido + especie + G)}</td></tr>
           <tr><td>Retención total (tipo fijo)</td><td>${fmtEur(retTot)}</td></tr>
           <tr><td>Retención desde nómina</td><td>− ${fmtEur(retTot - G)}</td></tr>
           <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoFlex_B)}</strong></td></tr>`;
      } else {
        document.getElementById('tablaRentingDetalle').innerHTML =
          `<tr><td>Bruto reducido (B − C)</td><td>${fmtEur(brutoReducido)}</td></tr>
           <tr><td>Base IRPF = B − C + especie</td><td>${fmtEur(baseA)}</td></tr>
           <tr><td>IRPF (flex)</td><td>− ${fmtEur(irpfA)}</td></tr>
           <tr><td><strong>Neto disponible</strong></td><td><strong>${fmtEur(netoFlex_A)}</strong></td></tr>`;
      }
    }

    const netoRentingMostrar = (ingresoCuentaSel === 'norepercutido') ? netoFlex_B : netoFlex_A;
    document.getElementById('kpiRenting').textContent = fmtEur(netoRentingMostrar);

    // ===== Aside resumen
    document.getElementById('rCompra').textContent = fmtEur(netoCompra);
    document.getElementById('rEntDirRep').textContent   = fmtEur(netEntDirRep);
    document.getElementById('rEntDirNoRep').textContent = fmtEur(netEntDirNoRep);
    document.getElementById('rEntPosRep').textContent   = fmtEur(netEntPosRep);
    document.getElementById('rEntPosNoRep').textContent = fmtEur(netEntPosNoRep);
    document.getElementById('rFlexRep').textContent = fmtEur(netoFlex_A);
    document.getElementById('rFlexNoRep').textContent = fmtEur(netoFlex_B);
    paintDeltaCell(document.getElementById('dEntDirRep'),   netEntDirRep   - netoCompra);
    paintDeltaCell(document.getElementById('dEntDirNoRep'), netEntDirNoRep - netoCompra);
    paintDeltaCell(document.getElementById('dEntPosRep'),   netEntPosRep   - netoCompra);
    paintDeltaCell(document.getElementById('dEntPosNoRep'), netEntPosNoRep - netoCompra);
    paintDeltaCell(document.getElementById('dRep'),         netoFlex_A     - netoCompra);
    paintDeltaCell(document.getElementById('dNoRep'),       netoFlex_B     - netoCompra);
    // Aplicar filtro visual tras actualizar valores
    filterResumen();
  }

  /* ===== Eventos ===== */
  const inputs = ['B','t','costeCompraMensual','Cmensual','p','V','tFlex','costeAdq','aniosUso','vmEntrega','tEnt'];
  inputs.forEach(id=>{
    const el = document.getElementById(id); if(!el) return;
    el.addEventListener('input', calc);
    el.addEventListener('blur', ()=>{ formatInput(el); calc(); });
    el.addEventListener('focus', ()=>{ unformatOnFocus(el); });
  });
  ['ecoRed','ingresoCuentaSel','ingresoEntregaSel','tipoEntrega','toggleTramos'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('change', ()=>{
      if(id==='tipoEntrega'){
        document.getElementById('bloquePosterior').style.display = (el.value === 'posterior') ? '' : 'none';
      }
      if(id==='toggleTramos'){
        const disabled = el.checked;
        ['t','tFlex','tEnt'].forEach(i=>{
          const x=document.getElementById(i);
          if(x){ x.disabled=disabled; x.style.opacity = disabled ? 0.6 : 1; }
        });
      }
      calc();
    });
  });

  // Listener específico del filtro de resultados
  const tipoResultadoSel = document.getElementById('tipoResultado');
  if (tipoResultadoSel) {
    tipoResultadoSel.addEventListener('change', filterResumen);
  }

  // Sync tipos fijos
  const same = document.getElementById('sameAsMarginal');
  const tInput = document.getElementById('t'); const tFlexInput = document.getElementById('tFlex');
  same.addEventListener('change', ()=>{ if(same.checked){ tFlexInput.value = tInput.value; formatInput(tFlexInput);} calc(); });
  tInput.addEventListener('input', ()=>{ if(same.checked){ tFlexInput.value = tInput.value; calc(); } });

  const sameEnt = document.getElementById('sameAsMarginalEnt');
  const tEntInput = document.getElementById('tEnt');
  sameEnt.addEventListener('change', ()=>{ if(sameEnt.checked){ tEntInput.value = tInput.value; formatInput(tEntInput);} calc(); });
  tInput.addEventListener('input', ()=>{ if(sameEnt.checked){ tEntInput.value = tInput.value; calc(); } });

  // Densidad compacta (si existe el control)
  const dens = document.getElementById('toggleDensity');
  if (dens) {
    dens.addEventListener('change', (e)=> {
      document.body.classList.toggle('compact', e.target.checked);
    });
    dens.checked = false;
  }

  /* ===== Modal: lógica (igual que antes) ===== */
  const modal = document.getElementById('configModal');
  const openBtn = document.getElementById('openConfig');
  const closeBtn = document.getElementById('closeConfig');
  openBtn.addEventListener('click', ()=>{ renderTramos(); renderEco(); modal.style.display='flex'; });
  function closeModal(){ modal.style.display='none'; }
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.style.display==='flex') closeModal(); });

  document.querySelectorAll('.tab-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.getElementById(b.dataset.tab).classList.add('active');
    });
  });

  function renderTramos(){
    const tbody = document.querySelector('#tablaTramos tbody');
    tbody.innerHTML='';
    const temp = TAX_TABLE.map(([limit, rate])=>[limit, Math.round(rate*10000)/100]);
    temp.forEach(([limit, pct], idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${isFinite(limit)
            ? `<input type="text" data-role="limit" value="${new Intl.NumberFormat('es-ES').format(limit)}" />`
            : `<input type="text" data-role="limit" value="En adelante" disabled />`}</td>
        <td><input type="text" data-role="rate" value="${String(pct).replace('.',',')}" /></td>
        <td class="row-actions">
          ${idx < temp.length-1 ? '<button type="button" data-action="del">Eliminar</button>' : '<span class="help">último</span>'}
        </td>`;
      tbody.appendChild(tr);
    });
  }
  document.getElementById('addTramo').addEventListener('click', ()=>{
    const tbody = document.querySelector('#tablaTramos tbody');
    const rows = tbody.querySelectorAll('tr');
    if(rows.length===0){ TAX_TABLE = JSON.parse(JSON.stringify(DEFAULT_TAX_TABLE)); renderTramos(); return; }
    const last = rows[rows.length-1];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" data-role="limit" value="50.000" /></td>
      <td><input type="text" data-role="rate" value="30" /></td>
      <td class="row-actions"><button type="button" data-action="del">Eliminar</button></td>`;
    tbody.insertBefore(tr, last);
  });
  document.querySelector('#tablaTramos tbody').addEventListener('click', (e)=>{
    if(e.target.dataset.action==='del'){
      e.target.closest('tr').remove();
    }
  });

  function readTramosFromUI(){
    const rows = Array.from(document.querySelectorAll('#tablaTramos tbody tr'));
    if(rows.length===0) return null;
    const parsed=[];
    for(let i=0;i<rows.length;i++){
      const limitInput = rows[i].querySelector('input[data-role="limit"]');
      const rateInput  = rows[i].querySelector('input[data-role="rate"]');
      let limitText = limitInput.value.trim();
      const isLast = (i === rows.length-1);

      let limit = isLast || /en\s+adelante/i.test(limitText)
        ? Infinity
        : parseLocaleNumber(limitText);

      // 👇 NUEVO: si parece “en miles”, convierto a euros
      if (isFinite(limit) && limit < 1000) limit *= 1000;

      const rate  = (String(rateInput.value).replace(',','.').trim()==='' ? NaN : Number(String(rateInput.value).replace(',','.')));
      if(!isLast && (!isFinite(limit) || limit<=0)) return {error:'Límites inválidos en tramos.'};
      if(!(rate>=0 && rate<=100)) return {error:'Tipos fuera de rango (0–100%).'};
      parsed.push([limit, rate/100]);
    }
    for(let i=1;i<parsed.length;i++){
      if(isFinite(parsed[i-1][0]) && isFinite(parsed[i][0]) && parsed[i][0] <= parsed[i-1][0]){
        return {error:'Los límites deben ir en orden ascendente.'};
      }
    }
    if(parsed[parsed.length-1][0] !== Infinity) parsed[parsed.length-1][0] = Infinity;
    return {data:parsed};
  }


  function renderEco(){
    const tbody = document.querySelector('#tablaEco tbody');
    tbody.innerHTML='';
    ECO_PRESETS.forEach((p,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" data-role="on" ${p.enabled?'checked':''} /></td>
        <td><input type="text" data-role="label" value="${p.label.replace(/"/g,'&quot;')}" /></td>
        <td><input type="text" data-role="value" value="${String(p.value*100).replace('.',',')}" /></td>
        <td class="row-actions"><button type="button" data-action="delEco" ${ECO_PRESETS.length<=1?'disabled':''}>Eliminar</button></td>`;
      tbody.appendChild(tr);
    });
  }
  document.getElementById('addEco').addEventListener('click', ()=>{
    ECO_PRESETS.push({enabled:true,label:'Nuevo preset',value:0.10});
    renderEco();
  });
  document.querySelector('#tablaEco tbody').addEventListener('click', (e)=>{
    if(e.target.dataset.action==='delEco'){
      const idx = Array.from(e.currentTarget.children).indexOf(e.target.closest('tr'));
      ECO_PRESETS.splice(idx,1);
      renderEco();
    }
  });
  function readEcoFromUI(){
    const rows = Array.from(document.querySelectorAll('#tablaEco tbody tr'));
    const res=[];
    for(const tr of rows){
      const on = tr.querySelector('input[data-role="on"]').checked;
      const label = tr.querySelector('input[data-role="label"]').value.trim() || 'Preset';
      const valPct = String(tr.querySelector('input[data-role="value"]').value).replace(',','.').trim();
      const v = Number(valPct);
      if(!(v>=0 && v<=90)) return {error:'Reducción eco fuera de rango (0–90%).'};
      res.push({enabled:on,label,value:v/100});
    }
    if(res.length===0) return {error:'Debe existir al menos un preset.'};
    return {data:res};
  }

  // Botones modal
  document.getElementById('resetConfig').addEventListener('click', ()=>{
    TAX_TABLE = JSON.parse(JSON.stringify(DEFAULT_TAX_TABLE));
    ECO_PRESETS = JSON.parse(JSON.stringify(DEFAULT_ECO));
    renderTramos(); renderEco(); populateEcoSelect(); calc();
  });
  document.getElementById('saveConfig').addEventListener('click', ()=>{
    const tramos = readTramosFromUI();
    if(tramos && tramos.error){ alert(tramos.error); return; }
    const eco = readEcoFromUI();
    if(eco && eco.error){ alert(eco.error); return; }
    if(tramos && tramos.data) TAX_TABLE = tramos.data;
    if(eco && eco.data) ECO_PRESETS = eco.data;
    populateEcoSelect();
    calc();
    closeModal();
  });

  // Estado inicial
  const densBox = document.getElementById('toggleDensity');
  if (densBox) densBox.checked = false;
  document.getElementById('toggleTramos').checked = false;
  ['t','tFlex','tEnt'].forEach(id=>{ const x=document.getElementById(id); if(x){ x.disabled=false; x.style.opacity=1; } });

  const initInputs = ['B','t','costeCompraMensual','Cmensual','p','V','tFlex','costeAdq','aniosUso','vmEntrega','tEnt'];
  initInputs.forEach(id=>{ const el=document.getElementById(id); if(el) formatInput(el); });
  document.getElementById('bloquePosterior').style.display = (document.getElementById('tipoEntrega').value === 'posterior') ? '' : 'none';
  populateEcoSelect();
  calc();
</script>



</body>
</html>
